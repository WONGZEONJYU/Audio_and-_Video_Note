# 1. Introduction

mp4⽂件格式⼜被称为MPEG-4 Part 14 , 出⾃MPEG-4标准第14部分 .它是⼀种多媒体格式容器，⼴泛⽤于包装视频和⾳频数据流、海报、字幕和元数据等。(顺便⼀提 , ⽬前流⾏的视频编码格式AVC/H264定义在MPEG-4 Part 10)

mp4⽂件格式基于Apple公司的QuickTime格式 , 因此 , [QuickTime File Format Specification](https://developer.apple.com/documentation/quicktime-file-format#//apple_ref/doc/uid/TP40000939-CH202-TPXREF101)也可以作为我们研究mp4的重要参考

MP4⽂件结构的资料 : [link]() 

mp4box⼤杀器 : [link](https://gpac.github.io/mp4box.js/test/filereader.html)

[[onlinemp4parser]](https://www.onlinemp4parser.com/)

# 2. Overview

mp4⽂件由box组成 , 每个box分为Header和Data。其中Header部分包含了box的类型和⼤⼩ , Data包含了⼦box或者数据 , **$\color{red}{\mathbf{box可以嵌套⼦box}}$**

下图是⼀个典型mp4⽂件的基本结构 : 

<img src="./assets/image-20240309203113502.png" alt="image-20240309203113502" />  

MP4⽂件的基本组成单元是box , 也就是说MP4⽂件是由各种各样的box组成的 , 有parent box , 还有children box。因此 , 这些boxes之间存在⼀定的层次关系 , 总结如下表所示 , 表中标记出了各个box必选或可选特性 , √ 代表Box必选

| **$\color{red}{\mathbf{ftyp}}$** |                                  |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{file\ type and\ compatibility}}$<br />$\color{red}{\mathbf{⽂件类型和兼容性}}$ |
| -------------------------------- | -------------------------------- | -------------------------------- | -------------------------------- | -------------------------------- | ------------------------------------ | ---- | :----------------------------------------------------------- |
| pdin                             |                                  |                                  |                                  |                                  |                                      |      | progressive download information                             |
| **$\color{red}{\mathbf{moov}}$** |                                  |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{container\ for\ all\ the\ metadata}}$<br/>$\color{red}{\mathbf{所有元数据的容器}}$ |
|                                  | **$\color{red}{\mathbf{mvhd}}$** |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{movie\ header,\ overall\ declarations}}$<br/>$\color{red}{\mathbf{电影头\ ,\ 整体声明}}$ |
|                                  | **$\color{red}{\mathbf{trak}}$** |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{container\ for\ an\ individual\ track\ or\ stream}}$<br/>$\color{red}{\mathbf{单个轨或流的容器}}$ |
|                                  |                                  | **$\color{red}{\mathbf{tkhd}}$** |                                  |                                  |                                      | √    | $\color{red}{\mathbf{track\ header,\ overall\ information\ about\ the track}}$<br />$\color{red}{\mathbf{轨的头部\ ,\ 关于该轨的概括信息\ ,\ ⽐如视频宽⾼}}$ |
|                                  |                                  | tref                             |                                  |                                  |                                      | √    | track reference container                                    |
|                                  |                                  | edts                             |                                  |                                  |                                      | √    | edit list container                                          |
|                                  |                                  |                                  | elst                             |                                  |                                      | √    | an edit list                                                 |
|                                  |                                  | **$\color{red}{\mathbf{mdia}}$** |                                  |                                  |                                      | √    | $\color{red}{\mathbf{container\ for\ the\ media\ information\ in\ a\ track}}$<br/>$\color{red}{\mathbf{轨媒体信息的容器}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{mdhd}}$** |                                  |                                      | √    | **$\color{red}{\mathbf{media\ header,\ overall\ information\ about\ the\ media}}$**<br/>$\color{red}{\mathbf{媒体头\ ,\ 关于媒体的总体信息}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{hdlr}}$** |                                  |                                      | √    | $\color{red}{\mathbf{handler,\ declares\ the\ media\ (handler)\ type}}$<br />$\color{red}{\mathbf{媒体的播放过程信息}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{minf}}$** |                                  |                                      | √    | $\color{red}{\mathbf{media\ information\ container}}$<br/>$\color{red}{\mathbf{媒体信息容器}}$ |
|                                  |                                  |                                  |                                  | vmhd                             |                                      |      | video media header, overall information<br/>(video track only) |
|                                  |                                  |                                  |                                  | smhd                             |                                      |      | sound media header, overall information<br/>(sound track only) |
|                                  |                                  |                                  |                                  | hmhd                             |                                      |      | hint media header, overall information<br/>(hint track only) |
|                                  |                                  |                                  |                                  | nmhd                             |                                      |      | Null media header, overall information<br/>(some tracks only) |
|                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{dinf}}$** |                                      | √    | $\color{red}{\mathbf{data\ information\ box,\ container}}$<br/>$\color{red}{\mathbf{数据信息box\ ,\ 容器}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{dref}}$**     | √    | $\color{red}{\mathbf{data\ reference\ box,\ declares\ source(s)\ of\ media\ data\ in\ track}}$<br/>$\color{red}{\mathbf{如何定位媒体信息}}$ |
|                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stbl}}$** |                                      | √    | $\color{red}{\mathbf{sample\ table\ box,\ container\ for\ the\ time\ /\ space\ map}}$<br/>$\color{red}{\mathbf{包含了track中的sample的所有时间和位置信息\ ,\ 以及sample的编解码等信息。}}$<br />$\color{red}{\mathbf{利⽤这个表可以解析sample的时序、类型、⼤⼩以及在各⾃存储容器中的位置}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stsd}}$**     | √    | $\color{red}{\mathbf{sample\ descriptions\ (codec\ types\ ,\ initialization\ etc.)}}$<br/>$\color{red}{\mathbf{如果是视频\ ,\ 包含:\ 编码类型、宽⾼、长度等信息;}}$<br/>$\color{red}{\mathbf{如果是⾳频\ ,\ 包含:\ 声道、采样率等信息}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stts}}$**     | √    | **$\color{red}{\mathbf{(decoding)\ time-to-sample}}$**<br/>**$\color{red}{\mathbf{描述了sample时序的映射⽅法 , 我们可以通过它找到任何时间的sample}}$** |
|                                  |                                  |                                  |                                  |                                  | ctts                                 |      | (composition) time to sample                                 |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stsc}}$**     | √    | $\color{red}{\mathbf{sample-to-chunk,\ partial\ data-offset\ information}}$<br/>$\color{red}{\mathbf{⽤chunk组织sample可以⽅便优化数据获取 , }}$<br/>$\color{red}{\mathbf{⼀个chunk包含⼀个或多个sample}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{SkyBlue}{\mathbf{stsz}}$** |      | **$\color{SkyBlue}{\mathbf{sample\ sizes\ (framing)}}$**<br/>**$\color{SkyBlue}{\mathbf{每个sample的⼤⼩}}$**<br/>$\color{SkyBlue}{\mathbf{虽然这⾥没有打勾 , 但对于mp4还是⾮常必要的}}$ |
|                                  |                                  |                                  |                                  |                                  | stz2                                 |      | compact sample sizes (framing)                               |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stco}}$**     | √    | $\color{red}{\mathbf{chunk\ offset\ partial\ data-offset\ information}}$<br/>$\color{red}{\mathbf{定义了每个chunk在媒体流中的偏移位置}}$ |
|                                  |                                  |                                  |                                  |                                  | co6                                  |      | 64-bit chunk offset                                          |
|                                  |                                  |                                  |                                  |                                  | 4                                    |      |                                                              |
|                                  |                                  |                                  |                                  |                                  | **$\color{SkyBlue}{\mathbf{stss}}$** |      | $\color{SkyBlue}{\mathbf{sync\ sample\ table\ (random\ access points)}}$<br/>$\color{SkyBlue}{\mathbf{⽤于确定media中的关键帧}}$ |
|                                  |                                  |                                  |                                  |                                  | stsh                                 |      | shadow sync sample table                                     |
|                                  |                                  |                                  |                                  |                                  | padb                                 |      | sample padding bits                                          |
|                                  |                                  |                                  |                                  |                                  | stdp                                 |      | sample degradation priority                                  |
|                                  |                                  |                                  |                                  |                                  | sdtp                                 |      | independent and disposable samples                           |
|                                  |                                  |                                  |                                  |                                  | sbgp                                 |      | sample-to-group                                              |
|                                  |                                  |                                  |                                  |                                  | sgpd                                 |      | sample group description                                     |
|                                  |                                  |                                  |                                  |                                  | subs                                 |      | sub-sample information                                       |
|                                  | mvex                             |                                  |                                  |                                  |                                      |      | movie extends box                                            |
|                                  |                                  | mehd                             |                                  |                                  |                                      |      | movie extends header box                                     |
|                                  |                                  | trex                             |                                  |                                  |                                      | √    | track extends defaults                                       |
|                                  | ipmc                             |                                  |                                  |                                  |                                      |      | IPMP Control Box                                             |
| moof                             |                                  |                                  |                                  |                                  |                                      |      | movie fragment                                               |
|                                  | mfhd                             |                                  |                                  |                                  |                                      | √    | movie fragment header                                        |
|                                  | traf                             |                                  |                                  |                                  |                                      |      | track fragment                                               |
|                                  |                                  | tfhd                             |                                  |                                  |                                      | √    | track fragment header                                        |
|                                  |                                  | trun                             |                                  |                                  |                                      |      | track fragment run                                           |
|                                  |                                  | sdtp                             |                                  |                                  |                                      |      | independent and disposable samples                           |
|                                  |                                  | sbgp                             |                                  |                                  |                                      |      | sample-to-group                                              |
|                                  |                                  | subs                             |                                  |                                  |                                      |      | sub-sample information                                       |
| mfra                             |                                  |                                  |                                  |                                  |                                      |      | movie fragment random access                                 |
|                                  | tfra                             |                                  |                                  |                                  |                                      |      | track fragment random access                                 |
|                                  | mfro                             |                                  |                                  |                                  |                                      | √    | movie fragment random access offset                          |
| mdat                             |                                  |                                  |                                  |                                  |                                      |      | media data container                                         |
| free                             |                                  |                                  |                                  |                                  |                                      |      | free space                                                   |
| skip                             |                                  |                                  |                                  |                                  |                                      |      | free space                                                   |
|                                  | udta                             |                                  |                                  |                                  |                                      |      | user-data                                                    |
|                                  |                                  | cprt                             |                                  |                                  |                                      |      | copyright etc                                                |
| meta                             |                                  |                                  |                                  |                                  |                                      |      | metadata                                                     |
|                                  | hdlr                             |                                  |                                  |                                  |                                      | √    | handler, declares the metadata (handler) type                |
|                                  | dinf                             |                                  |                                  |                                  |                                      |      | data information box, container                              |
|                                  |                                  | dref                             |                                  |                                  |                                      |      | data reference box, declares source(s) of metadata items     |
|                                  | ipmc                             |                                  |                                  |                                  |                                      |      | IPMP Control Box                                             |
|                                  | iloc                             |                                  |                                  |                                  |                                      |      | item location                                                |
|                                  | ipro                             |                                  |                                  |                                  |                                      |      | item protection                                              |
|                                  |                                  | sinf                             |                                  |                                  |                                      |      | protection scheme information box                            |
|                                  |                                  |                                  | frma                             |                                  |                                      |      | original format box                                          |
|                                  |                                  |                                  | imif                             |                                  |                                      |      | IPMP Information box                                         |
|                                  |                                  |                                  | schm                             |                                  |                                      |      | scheme type box                                              |
|                                  |                                  |                                  | schi                             |                                  |                                      |      | scheme information box                                       |
|                                  | iinf                             |                                  |                                  |                                  |                                      |      | item information                                             |
|                                  | xml                              |                                  |                                  |                                  |                                      |      | XML container                                                |
|                                  | bxml                             |                                  |                                  |                                  |                                      |      | binary XML container                                         |
|                                  | pitm                             |                                  |                                  |                                  |                                      |      | primary item reference                                       |
|                                  | fiin                             |                                  |                                  |                                  |                                      |      | file delivery item information                               |
|                                  |                                  | paen                             |                                  |                                  |                                      |      | partition entry                                              |
|                                  |                                  |                                  | fpar                             |                                  |                                      |      | file partition                                               |
|                                  |                                  |                                  | fecr                             |                                  |                                      |      | FEC reservoir                                                |
|                                  |                                  | segr                             |                                  |                                  |                                      |      | file delivery session group                                  |
|                                  |                                  | gitn                             |                                  |                                  |                                      |      | group id to name                                             |
|                                  |                                  | tsel                             |                                  |                                  |                                      |      | track selection                                              |
| meco                             |                                  |                                  |                                  |                                  |                                      |      | additional metadata container                                |
|                                  | mere                             |                                  |                                  |                                  |                                      |      | metabox relation                                             |

本⽂使⽤mediainfo和mp4box进⾏分析

图中看到mp4⽂件由⼏个主要组成部分 , 下⾯以📎 2_audio_track_5s.mp4⽂件为分析案例

## 2.1 ftyp

> ```c++
> aligned(8) class FileTypeBox
>    extends Box(‘ftyp’) {
>    unsigned int(32)  major_brand;
>    unsigned int(32)  minor_version;
>    unsigned int(32) compatible_brands[];
> }
> ```

- major_brand : 因为兼容性一般可以分为推荐兼容性和默认兼容性。这里 major_brand 就相当于是推荐兼容性。一般而言都是使用 `isom` 这个万金油即可。如果是需要特定的格式 ,可 以自行定义
- minor_version : 指最低兼容版本。
- compatible_brands : 和 major_brand 类似 , 通常是针对 MP4 中包含的额外格式 , 比如 : AVC , AAC 等相当于的音视频解码格式

File Type Box , ⼀般在⽂件的开始位置 , 描述的⽂件的版本、兼容协议等

ftyp内容

> ```tex
> 000000 File Type (32 bytes)
> 000000  Header (8 bytes)
> 000000   Size:                                 32 (0x00000020)
> 000004   Name:                                 ftyp
> 000008  MajorBrand:                            isom
> 00000C  MajorBrandVersion:                     512 (0x00000200)
> 000010  CompatibleBrand:                       isom
> 000014  CompatibleBrand:                       iso2
> 000018  CompatibleBrand:                       avc1
> 00001C  CompatibleBrand:                       mp41
> ```

## 2.2 moov

> ```c++
> aligned(8) class MovieExtendsBox extends Box(‘mvex’){ }
> ```

Movie Box , 含本⽂件中所有媒体数据的宏观描述信息以及每路媒体轨道的具体信息。⼀般位于放在⽂件末尾 , 但如果为了⽀持http边下载边播放则需要将moov提前。注意 , $\color{red}{\mathbf{当改变moov位置时,内部⼀些值需要重新计算}}$​

moov内容

> ```tex
> 14B2CE File header (10341 bytes)
> 14B2CE  Header (8 bytes)
> 14B2CE   Size:                                 10341 (0x00002865)
> 14B2D2   Name:                                 moov
> ```

moov里面的box才是我们主要分析的box  

<img src="assets/image-20240311093535367.png" alt="image-20240311093535367" />  

## 2.3 mdat

Media Data Box , 存放具体的媒体数据

> ```tex
> 000028 Data (1356454 bytes)
> 000028  Header (8 bytes)
> 000028   Size:                                 1356454 (0x0014B2A6)
> 00002C   Name:                                 mdat
> 000030  Data:                                  (1356446 bytes)
> ```

此处是视频和音频的真正数据  , 他的索引和编解码信息都在以下介绍的BOX存储

# 3. Moov Insider

> ```c++
> aligned(8) class MovieExtendsBox extends Box(‘mvex’){ }
> ```

mp4的媒体数据信息主要存放在Moov Box中 , 是我们需要分析的重点。moov的主要组成部分如下 : 

## 3.1 mvhd

> ```c++
> aligned(8) class MovieHeaderBox extends FullBox(‘mvhd’, version, 0) { 
>     if (version==1) {
>    unsigned int(64)  creation_time;
>    unsigned int(64)  modification_time;
>    unsigned int(32)  timescale;
>    unsigned int(64)  duration;
> } else { // version==0
>    unsigned int(32)  creation_time;
>    unsigned int(32)  modification_time;
>    unsigned int(32)  timescale;
>    unsigned int(32)  duration;
> }
> template int(32)  rate = 0x00010000; // typically 1.0
> template int(16)  volume = 0x0100;   // typically, full volume
> const bit(16)  reserved = 0;
> const unsigned int(32)[2]  reserved = 0;
> template int(32)[9]  matrix =
> { 0x00010000,0,0,0,0x00010000,0,0,0,0x40000000 };
>       // Unity matrix
>    bit(32)[6]  pre_defined = 0;
>    unsigned int(32)  next_track_ID;
> }
> ```

- version: 一般默认为 0
- creation_time: 创建的时间 , 从 1904 年开始算起 , 用秒来表示
- timescale : 时间比例 , 通过该值和 duration 来算出实际时间
- duration : 持续时间 , 单位是根据 timescale 来决定的 , 实际时间为：duration / timescale = xx 秒。
- rate: 播放比例
- volume: 音量大小 , 0x0100 为最大值。
- matrix: 不解释 , 我也不懂
- next_track_ID : 需要比当前 trak_id 最大值还大才行 , 一般随便填个很大的值即可。

大致的填充

> ```c++
> new Uint8Array([
> 		0x00, 0x00, 0x00, 0x00, // version(0) + flags
> 		0x00, 0x00, 0x00, 0x00, // creation_time
> 		0x00, 0x00, 0x00, 0x00, // modification_time
> 		(timescale >>> 24) & 0xFF, // timescale: 4 bytes
> 		(timescale >>> 16) & 0xFF,
> 		(timescale >>> 8) & 0xFF,
> 		(timescale) & 0xFF,
> 		(duration >>> 24) & 0xFF, // duration: 4 bytes
> 		(duration >>> 16) & 0xFF,
> 		(duration >>> 8) & 0xFF,
> 		(duration) & 0xFF,
> 		0x00, 0x01, 0x00, 0x00, // Preferred rate: 1.0
> 		0x01, 0x00, 0x00, 0x00, // PreferredVolume(1.0, 2bytes) + reserved(2bytes)
> 		0x00, 0x00, 0x00, 0x00, // reserved: 4 + 4 bytes
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x01, 0x00, 0x00, // ----begin composition matrix----
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x01, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x40, 0x00, 0x00, 0x00, // ----end composition matrix----
> 		0x00, 0x00, 0x00, 0x00, // ----begin pre_defined 6 * 4 bytes----
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00,
> 		0x00, 0x00, 0x00, 0x00, // ----end pre_defined 6 * 4 bytes----
> 		0xFF, 0xFF, 0xFF, 0xFF // next_track_ID
> 	]);
> ```

Movie Header Box , 记录整个媒体⽂件的描述信息 , 如创建时间、修改时间、时间度量标尺、可播放时长等

例如 : 可以获取文件件信息如时长为 Duration: 5016 ms

mvhd内容

> ```tex
> 14B2D6  Movie header (108 bytes)
> 14B2D6   Header (8 bytes)
> 14B2D6    Size:                                108 (0x0000006C)
> 14B2DA    Name:                                mvhd
> 14B2DE   Version:                              0 (0x00)
> 14B2DF   Flags:                                0 (0x000000)
> 14B2E2   Creation time:                        0 (0x00000000) - 
> 14B2E6   Modification time:                    0 (0x00000000) - 
> 14B2EA   Time scale:                           1000 (0x000003E8) - 1000 Hz
> 14B2EE   Duration:                             5016 (0x00001398) - 5016 ms
> 14B2F2   Preferred rate:                       65536 (0x00010000) - 1.000
> 14B2F6   Preferred volume:                     256 (0x0100) - 1.000
> 14B2F8   Reserved:                             (10 bytes)
> 14B302   Matrix structure (36 bytes)
> 14B302    a (width scale):                     1.000
> 14B306    b (width rotate):                    0.000
> 14B30A    u (width angle):                     0.000
> 14B30E    c (height rotate):                   0.000
> 14B312    d (height scale):                    1.000
> 14B316    v (height angle):                    0.000
> 14B31A    x (position left):                   0.000
> 14B31E    y (position top):                    0.000
> 14B322    w (divider):                         1.000
> 14B326   Preview time:                         0 (0x00000000)
> 14B32A   Preview duration:                     0 (0x00000000)
> 14B32E   Poster time:                          0 (0x00000000)
> 14B332   Selection time:                       0 (0x00000000)
> 14B336   Selection duration:                   0 (0x00000000)
> 14B33A   Current time:                         0 (0x00000000)
> 14B33E   Next track ID:                        4 (0x00000004)
> ```

<img src="assets/image-20240311095951225.png" alt="image-20240311095951225" /> 

## 3.2 udta

User Data Box , 自定义数据

> ```tex
> 14DAD1  User Data (98 bytes)
> 14DAD1   Header (8 bytes)
> 14DAD1    Size:                                98 (0x00000062)
> 14DAD5    Name:                                udta
> ```

## 3.3 trak

> ```c++
> aligned(8) class TrackBox extends Box(‘trak’) { }
> ```

<img src="assets/image-20240313105431588.png" alt="image-20240313105431588" /> 

Trak Box , 记录媒体流信息 , 文件中可以存在 **$\color{red}{\mathbf{⼀个或多个trak}}$** , 它们之间是相互独立的  

<img src="assets/image-20240311101500562.png" alt="image-20240311101500562" /> 

本次的示例文件里面有3个trak

每个trak包含以下几个组成部分 : 

### 3.3.1 tkhd

tkhd 是 trak box 的子一级 box 的内容 , 主要是用来描述该特定 trak 的相关内容信息

> ```c++
> aligned(8) class TrackHeaderBox
> extends FullBox(‘tkhd’, version, flags){ if (version==1) {
>       unsigned int(64)  creation_time;
>       unsigned int(64)  modification_time;
>       unsigned int(32)  track_ID;
>       const unsigned int(32)  reserved = 0;
>       unsigned int(64)  duration;
>    } else { // version==0
>       unsigned int(32)  creation_time;
>       unsigned int(32)  modification_time;
>       unsigned int(32)  track_ID;
>       const unsigned int(32)  reserved = 0;
>       unsigned int(32)  duration;
> }
> const unsigned int(32)[2] reserved = 0;
> template int(16) layer = 0;
> template int(16) alternate_group = 0;
> template int(16) volume = {if track_is_audio 0x0100 else 0}; 
> const unsigned int(16) reserved = 0;
> template int(32)[9] matrix=
> { 0x00010000,0,0,0,0x00010000,0,0,0,0x40000000 };
>       // unity matrix
>    unsigned int(32) width;
>    unsigned int(32) height;
> }
> ```

- creation_time : 创建时间 , 非必须
- modification_time : 修改时间 ,非必须
- track_ID : 指明当前描述的 track ID。
- duration : 当前 track 内容持续的时间。通常结合 timescale 进行相关计算。
- layer : 没啥用。通常用来作为分层 video trak 的使用。
- alternate_group : 可替换 track 源。如果为 0 表示当前 track 没有指定的 track 源替代。非 0 的话 , 则表示存在多个源的 group。
- volume : 用来确定音量大小 , 满音量为1(0x0100)
- width and height : 确定视频的宽高

Track Header Box , 包含关于媒体流的头信息。下图示例中 , 可以看到流信息如视频流宽度(width)1920 , 高度(height)800

1. 视频tkhd内容

> ```tex
> 14CEA6   Track Header - 3 (0x3) - 4875 (0x130B) ms (92 bytes)
> 14CEA6    Header (8 bytes)
> 14CEA6     Size:                               92 (0x0000005C)
> 14CEAA     Name:                               tkhd
> 14CEAE    Version:                             0 (0x00)
> 14CEAF    Flags:                               3 (0x000003)
> 14CEB2    Track Enabled:                       Yes
> 14CEB2    Track in Movie:                      Yes
> 14CEB2    Track in Preview:                    No
> 14CEB2    Track in Poster:                     No
> 14CEB2    Creation time:                       0 (0x00000000) - 
> 14CEB6    Modification time:                   0 (0x00000000) - 
> 14CEBA    Track ID:                            3 (0x00000003)
> 14CEBE    Reserved:                            0 (0x00000000)
> 14CEC2    Duration:                            4875 (0x0000130B) - 4875 (0x130B) ms
> 14CEC6    Reserved:                            0 (0x00000000)
> 14CECA    Reserved:                            0 (0x00000000)
> 14CECE    Layer:                               0 (0x0000)
> 14CED0    Alternate group:                     2 (0x0002)
> 14CED2    Volume:                              0 (0x0000) - 0.000
> 14CED4    Reserved:                            0 (0x0000)
> 14CED6    Matrix structure (36 bytes)
> 14CED6     a (width scale):                    1.000
> 14CEDA     b (width rotate):                   0.000
> 14CEDE     u (width angle):                    0.000
> 14CEE2     c (height rotate):                  0.000
> 14CEE6     d (height scale):                   1.000
> 14CEEA     v (height angle):                   0.000
> 14CEEE     x (position left):                  0.000
> 14CEF2     y (position top):                   0.000
> 14CEF6     w (divider):                        1.000
> 14CEFA    Track width:                         1920.000
> 14CEFE    Track height:                        800.000
> ```

<img src="assets/image-20240311110856586.png" alt="image-20240311110856586" /> 

2. 音频的tkhd , 则比如 duration、volume

> ```tex
> 14B34A   Track Header - 1 (0x1) - 5016 (0x1398) ms (92 bytes)
> 14B34A    Header (8 bytes)
> 14B34A     Size:                               92 (0x0000005C)
> 14B34E     Name:                               tkhd
> 14B352    Version:                             0 (0x00)
> 14B353    Flags:                               3 (0x000003)
> 14B356    Track Enabled:                       Yes
> 14B356    Track in Movie:                      Yes
> 14B356    Track in Preview:                    No
> 14B356    Track in Poster:                     No
> 14B356    Creation time:                       0 (0x00000000) - 
> 14B35A    Modification time:                   0 (0x00000000) - 
> 14B35E    Track ID:                            1 (0x00000001)
> 14B362    Reserved:                            0 (0x00000000)
> 14B366    Duration:                            5016 (0x00001398) - 5016 (0x1398) ms
> 14B36A    Reserved:                            0 (0x00000000)
> 14B36E    Reserved:                            0 (0x00000000)
> 14B372    Layer:                               0 (0x0000)
> 14B374    Alternate group:                     0 (0x0000)
> 14B376    Volume:                              256 (0x0100) - 1.000
> 14B378    Reserved:                            0 (0x0000)
> 14B37A    Matrix structure (36 bytes)
> 14B37A     a (width scale):                    1.000
> 14B37E     b (width rotate):                   0.000
> 14B382     u (width angle):                    0.000
> 14B386     c (height rotate):                  0.000
> 14B38A     d (height scale):                   1.000
> 14B38E     v (height angle):                   0.000
> 14B392     x (position left):                  0.000
> 14B396     y (position top):                   0.000
> 14B39A     w (divider):                        1.000
> 14B39E    Track width:                         0.000
> 14B3A2    Track height:                        0.000
> ```

<img src="assets/image-20240311111015163.png" alt="image-20240311111015163" /> 

### 3.3.2 mdia

> ```c++
> aligned(8) class MediaBox extends Box(‘mdia’) { }
> ```

Media Box , 这是⼀个包含track媒体数据信息的 container box , 子 box包括 : 

1. mdhd : Media Header Box , 存放视频流创建时间 , 长度等信息
2. hdlr : Handler Reference Box , 媒体的播放过程信息
3. minf : Media Information Box , 解释track媒体数据的handler-specific信息

minf 同样是个container box , 其内部需要关注的内容是stbl , 这也是moov中最复杂的部分。stbl包含了媒体流每⼀个sample在文件件中的offset , pts , duration等信息。想要播放⼀个mp4文件 , 必须根据stbl正确找到每个sample并送给解码器

mdia内容

> ```tex
> 14B3CA   Media (3184 bytes)
> 14B3CA    Header (8 bytes)
> 14B3CA     Size:                               3184 (0x00000C70)
> 14B3CE     Name:                               mdia
> ```

<img src="assets/image-20240311104906794.png" alt="image-20240311104906794" /> 

#### 3.3.2.1 mdhd 

> mdhd 和 tkhd 来说 , 内容大致都是一样的。不过 , tkhd 通常是对指定的 track 设定相关属性和内容。而 mdhd 是针对于独立的 media 来设置的。不过事实上 , 两者一般都是一样的

> ```c++
> aligned(8) class MediaHeaderBox extends FullBox(‘mdhd’, version, 0) { if (version==1) {
>       unsigned int(64)  creation_time;
>       unsigned int(64)  modification_time;
>       unsigned int(32)  timescale;
>       unsigned int(64)  duration;
>    } else { // version==0
>       unsigned int(32)  creation_time;
>       unsigned int(32)  modification_time;
>       unsigned int(32)  timescale;
>       unsigned int(32)  duration;
> }
> bit(1) pad = 0;
> unsigned int(5)[3] language; // ISO-639-2/T language code unsigned int(16) pre_defined = 0;
> }
> ```
>
> 里面就有 3 个额外的字段 : pad , language , pre_defined
>
> - pad: 占位符 , 通常为 0
> - language : 表明当前 trak 的语言。因为该字段总长为 15bit , 通常是和 pad 组合成为 2B 的长度。
> - pre_defined: 默认为 0.

> ```c++
> new Uint8Array([
>     0x00, 0x00, 0x00, 0x00, // version(0) + flags
>     0x00, 0x00, 0x00, 0x00, // creation_time
>     0x00, 0x00, 0x00, 0x00, // modification_time
>     (timescale >>> 24) & 0xFF, // timescale: 4 bytes
>     (timescale >>> 16) & 0xFF,
>     (timescale >>> 8) & 0xFF,
>     (timescale) & 0xFF,
>     (duration >>> 24) & 0xFF, // duration: 4 bytes
>     (duration >>> 16) & 0xFF,
>     (duration >>> 8) & 0xFF,
>     (duration) & 0xFF,
>     0x55, 0xC4, // language: und (undetermined)
>     0x00, 0x00 // pre_defined = 0
>   ])
> ```

Media Header Box , 存放视频流创建时间 , 长度等信息

视频的mdhd , Time scale , Duration等信息  

1. 视频mdhd内容

> ```tex
> 14CF3A    Media Header (32 bytes)
> 14CF3A     Header (8 bytes)
> 14CF3A      Size:                              32 (0x00000020)
> 14CF3E      Name:                              mdhd
> 14CF42     Version:                            0 (0x00)
> 14CF43     Flags:                              0 (0x000000)
> 14CF46     Creation time:                      0 (0x00000000) - 
> 14CF4A     Modification time:                  0 (0x00000000) - 
> 14CF4E     Time scale:                         90000 (0x00015F90)
> 14CF52     Duration:                           438750 (0x0006B1DE) - 4875 (0x130B) ms
> 14CF56     Language:                           21956 (0x55C4) - und
> 14CF58     Quality:                            0 (0x0000)
> ```

<img src="assets/image-20240311112415602.png" alt="image-20240311112415602" /> 

音频的mdhd , 也类似视频mdhd的信息 , 但要注意 **$\color{red}{\mathbf{Time\ scale}}$** , 我们在计算时间戳的时候都要使用该 **$\color{red}{\mathbf{Time\ scale\ ,\ 对应我们流里面的AVStream->time\\\_base}}$**

2. 音频mdhdn内容

> ```tex
> 14B3D2    Media Header (32 bytes)
> 14B3D2     Header (8 bytes)
> 14B3D2      Size:                              32 (0x00000020)
> 14B3D6      Name:                              mdhd
> 14B3DA     Version:                            0 (0x00)
> 14B3DB     Flags:                              0 (0x000000)
> 14B3DE     Creation time:                      0 (0x00000000) - 
> 14B3E2     Modification time:                  0 (0x00000000) - 
> 14B3E6     Time scale:                         44100 (0x0000AC44)
> 14B3EA     Duration:                           221184 (0x00036000) - 5015 (0x1397) ms
> 14B3EE     Language:                           21956 (0x55C4) - und
> 14B3F0     Quality:                            0 (0x0000)
> ```

<img src="assets/image-20240311112517657.png" alt="image-20240311112517657" /> 

#### 3.3.2.2 hdlr

> ```c++
> aligned(8) class HandlerBox extends FullBox('hdlr', version = 0, 0) { 
> unsigned int(32) pre_defined = 0;
> unsigned int(32) handler_type;
> const unsigned int(32)[3] reserved = 0;
> string name;
> }
> ```

hdlr 是用来设置不同 trak 的处理方式的 , 重点是handler_type / Component subtype , 常见处理方式 : 

- vide : Video track
- soun : Audio track
- hint : Hint track
- meta : Timed Metadata track
- auxv : Auxiliary Video track

其中有两字段需要额外说明一下 : 

- handler_type：是代指具体 trak 的处理类型。也就是我们上面列写的 vide,soun,hint 字段。
- name: 是用来写名字的。其主要不是给机器读的 , 而是给人读 , 所以 ,这里你只要觉得能表述清楚 , 填啥其实都行

handler_type 填的值其实就是 string 转换为 hex 之后得到的值 , 比如 : 

> ```tex
> vide 为 0x76, 0x69, 0x64, 0x65
> soun 为 0x73, 0x6F, 0x75, 0x6E
> ```

Handler Reference Box , 媒体的播放过程信息

视频的hdlr , 重点 **$\color{red}{\mathbf{Component\ subtype\ :\ vide}}$**

> ```tex
> 14CF5A    Handler Reference (45 bytes)
> 14CF5A     Header (8 bytes)
> 14CF5A      Size:                              45 (0x0000002D)
> 14CF5E      Name:                              hdlr
> 14CF62     Version:                            0 (0x00)
> 14CF63     Flags:                              0 (0x000000)
> 14CF66     Component type:                     
> 14CF6A     Component subtype:                  vide
> 14CF6E     Component manufacturer:             
> 14CF72     Component flags:                    0 (0x00000000)
> 14CF76     Component flags mask:               0 (0x00000000)
> 14CF7A     Component name:                     VideoHandler
> ```

<img src="assets/image-20240311140100238.png" alt="image-20240311140100238" /> 

音频的hdlr ,   **$\color{red}{\mathbf{Component\ subtype\ :\ soun}}$**

如果我们多个音轨的时候 , Component name : 粤语

> ```tex
> 14B3F2    Handler Reference (39 bytes)
> 14B3F2     Header (8 bytes)
> 14B3F2      Size:                              39 (0x00000027)
> 14B3F6      Name:                              hdlr
> 14B3FA     Version:                            0 (0x00)
> 14B3FB     Flags:                              0 (0x000000)
> 14B3FE     Component type:                     
> 14B402     Component subtype:                  soun
> 14B406     Component manufacturer:             
> 14B40A     Component flags:                    0 (0x00000000)
> 14B40E     Component flags mask:               0 (0x00000000)
> 14B412     Component name:                     粤语
> ```

<img src="assets/image-20240311140619611.png" alt="image-20240311140619611" /> 

Component name : 国语

> ```tex
> 14C0EA    Handler Reference (39 bytes)
> 14C0EA     Header (8 bytes)
> 14C0EA      Size:                              39 (0x00000027)
> 14C0EE      Name:                              hdlr
> 14C0F2     Version:                            0 (0x00)
> 14C0F3     Flags:                              0 (0x000000)
> 14C0F6     Component type:                     
> 14C0FA     Component subtype:                  soun
> 14C0FE     Component manufacturer:             
> 14C102     Component flags:                    0 (0x00000000)
> 14C106     Component flags mask:               0 (0x00000000)
> 14C10A     Component name:                     国语
> ```

<img src="assets/image-20240311140648462.png" alt="image-20240311140648462" /> 

#### 3.3.2.3 minf

> ```c++
> aligned(8) class MediaInformationBox extends Box(‘minf’) { }
> ```

minf : Media Information Box , 解释track媒体数据的handler-specific信息 , minf同样是个container box , 其内部需要关注的内容是stbl , 这也是moov中最复杂的部分。

stbl包含了媒体流每⼀个sample在文件中的offset , pts , duration等信息。想要播放⼀个mp4⽂件 , 必须根据stbl正确找到每个sample并送给解码器

而且需要注意的是 , minf⾥⾯的子容器 , 音频和视频轨是有区别的 , 比如视频轨 : **$\color{red}{\mathbf{vmhd}}$** , 音频轨则为 : **$\color{red}{\mathbf{smhd}}$​**  

##### 3.3.2.3.1 v/smhd

v/smhd 是对当前 trak 的描述 box , vmhd 针对的是 video , smhd 针对的是 audio。这两个盒子在解码中 , 非不可或缺的(有时候得看播放器) , 缺了的话 , 有可能会被认为格式不正确

1. vmhd

> ```c++
> aligned(8) class VideoMediaHeaderBox
> extends FullBox(‘vmhd’, version = 0, 1) {
> template unsigned int(16) graphicsmode = 0; // copy, see below 
> template unsigned int(16)[3] opcolor = {0, 0, 0};
> }
> ```



> ```tex
> 14CF8F     Video Media Header (20 bytes)
> 14CF8F      Header (8 bytes)
> 14CF8F       Size:                             20 (0x00000014)
> 14CF93       Name:                             vmhd
> 14CF97      Version:                           0 (0x00)
> 14CF98      Flags:                             1 (0x000001)
> 14CF9B      Graphic mode:                      0 (0x0000)
> 14CF9D      Graphic mode color R:              0 (0x0000)
> 14CF9F      Graphic mode color G:              0 (0x0000)
> 14CFA1      Graphic mode color B:              0 (0x0000)
> ```

<img src="assets/image-20240311140912380.png" alt="image-20240311140912380" /> 

2. smhd

> ```c++
> aligned(8) class SoundMediaHeaderBox
>    extends FullBox(‘smhd’, version = 0, 0) {
>    template int(16) balance = 0;
>    const unsigned int(16)  reserved = 0;
> }
> ```
>
> 其中 , balance 这个字段相当于和我们通常设置的左声道 , 右声道有关
>
> balance : 该值是一个浮点值 , 0 为 center , 1.0 为 right , -1.0 为 left

> ```tex
> 14B421     Sound Media Header (16 bytes)
> 14B421      Header (8 bytes)
> 14B421       Size:                             16 (0x00000010)
> 14B425       Name:                             smhd
> 14B429      Version:                           0 (0x00)
> 14B42A      Flags:                             0 (0x000000)
> 14B42D      Audio balance:                     0 (0x0000)
> 14B42F      Reserved:                          0 (0x0000)
> ```

<img src="assets/image-20240311140932150.png" alt="image-20240311140932150" /> 

##### 3.3.2.3.2 dinf

> ```c++
> aligned(8) class DataInformationBox extends Box(‘dinf’) { }
> ```

###### 3.3.2.3.2.1 dref

dref 是用来设置当前 Box 描述信息的 data_entry , 基本格式为 : 

> ```c++
> aligned(8) class DataReferenceBox
>    extends FullBox(‘dref’, version = 0, 0) {
>    unsigned int(32)  entry_count;
>    for (i=1; i <= entry_count; i++) {
>     DataEntryBox(entry_version, entry_flags) data_entry; }
> }
> ```
>
> 其中的 DataEntryBox 就是 DataEntryUrlBox/DataEntryUrnBox 中的一个。简单来说，就是 dref 下的子 box – `url` 或者 `urn` 这两个 box。其中，entry_version 和 entry_flags 需要额外说明一下。
>
> - entry_version : 用来指明当前 entry 的格式
> - entry_flags : 其值不是固定的 , 但是有一个特殊的值 , 0x000001 用来表示当前 media 的数据和 moov 包含的数据一致
>
> 不过 , 就通常来说 , 我真的没有用到过有实际数据的 dref 。所以 , 这里就不衍生来讲了
>
> url
>
> url box 是由 dref 包裹的子一级 box , 里面是对不同的 sample 的描述信息。不过 , 一般都是附带在其它 box 里。其基本格式为 : 
>
> ```c++
> aligned(8) class DataEntryUrlBox (bit(24) flags) extends FullBox(‘url ’, version = 0, flags) { 
>     string location;
> }
> ```
>
> 实际并没有用到过 `location` 这个字段 , 所以 , 一般也就不需要了

# 4. Stbl Insider

Sample Table Box , 上⽂提到mdia中最主要的部分是存放⽂件中每个sample信息的stbl。在解析stbl前 , 我们需要区分chunk和sample这两个概念。
在mp4⽂件中 , sample是⼀个媒体流的基本单元 , 例如视频流的⼀个sample代表实际的nal数据。**$\color{red}{\mathbf{chunk\ 是数据存储的基本单位}}$​** , 它是一系列sample数据的集合 , 一个chunk中可以包含⼀个或多的sample

> ```tex
> "stbl"包含了关于track中sample所有时间和位置的信息,以及sample的编解码等信息,利用这个表,可以解释sample的时序、类型、大小以及在各自存储容器中的位置。
> "stbl"是一个container box,其子box包括:
> sample description box(stsd)
> time to sample box(stts)
> sample size box(stsz或stz2)、
> sample to chunk box(stsc)、
> chunk offset box(stco或co64)、
> composition time to sample box(ctts)、
> sync sample box(stss)等
> "stsd"必不可少,且至少包含一个条目,该box包含了data reference box进行sample数据检索的信息。没有“stsd”就无法计算media sample的存储位置。"stsd"包含了编码的信息,其存储的信息随媒体类型不同而不同
> ```

<img src="assets/image-20240311145050516.png" alt="image-20240311145050516" style="zoom:150%;" /> 

⼀个chunk包含⼀个或多个sample

stbl⽤来描述每个sample的信息，包含以下几个主要的子box : 

## 4.1 stsd

Sample Description Box , 存放解码必须的描述信息

> ```tex
> box header和version字段后会有一个entry count字段,根据entry的个数,每个entry会有type信息,如"vide"、"sund"等,根据type不同sample description会提供不同的信息,例如对于video track,会有“VisualSampleEntry”类型信息,对于audio track会有"AudioSampleEntry"类型信息。
> 视频的编码类型、宽高、长度,音频的声道、采样等信息都会出现在这个box中
> ```

对于h264的视频流 , 其具体类型为 avc1 , extensions中其中存放有sps , pps等解码必要信息

1. 视频stsd内容

> ```tex
> 14CFCF      Sample Description (174 bytes)
> 14CFCF       Header (8 bytes)
> 14CFCF        Size:                            174 (0x000000AE)
> 14CFD3        Name:                            stsd
> 14CFD7       Version:                          0 (0x00)
> 14CFD8       Flags:                            0 (0x000000)
> 14CFDB       Count:                            1 (0x00000001)
> ```

<img src="assets/image-20240311152434467.png" alt="image-20240311152434467" /> 

里面包含了avc1，avc1里面⼜包含了avcC和pasp  

<img src="assets/image-20240311152128041.png" alt="image-20240311152128041" /> 

* avc1 : 包含了视频Width、Height

> ```tex
> 14CFDF       Video (158 bytes)
> 14CFDF        Header (8 bytes)
> 14CFDF         Size:                           158 (0x0000009E)
> 14CFE3         Name:                           avc1
> 14CFE7        Reserved:                        0 (0x0000000000000000)
> 14CFED        Data reference index:            1 (0x0001)
> 14CFEF        Version:                         0 (0x0000)
> 14CFF1        Revision level:                  0 (0x0000)
> 14CFF3        Vendor:                          
> 14CFF7        Temporal quality:                0 (0x00000000)
> 14CFFB        Spatial quality:                 0 (0x00000000)
> 14CFFF        Width:                           1920 (0x0780)
> 14D001        Height:                          800 (0x0320)
> 14D003        Horizontal resolution:           4718592 (0x00480000)
> 14D007        Vertical resolution:             4718592 (0x00480000)
> 14D00B        Data size:                       0 (0x00000000)
> 14D00F        Frame count:                     1 (0x0001)
> 14D011        Compressor name size:            0 (0x00)
> 14D012        Padding:                         (31 bytes)
> 14D031        Depth:                           24 (0x0018)
> 14D033        Color table ID:                  65535 (0xFFFF)
> ```

<img src="assets/image-20240311160102067.png" alt="image-20240311160102067" /> 

* avcC : 包含了视频编码器相关的信息 , 包括sps、pps等信息 

> ```tex
> 14D035        AVC decode (56 bytes)
> 14D035         Header (8 bytes)
> 14D035          Size:                          56 (0x00000038)
> 14D039          Name:                          avcC
> 14D03D         Version:                        1 (0x01)
> 14D03E         Specific (47 bytes)
> 14D03E          AVCProfileIndication:          100 (0x64)
> 14D03F          profile_compatibility:         0 (0x00)
> 14D040          AVCLevelIndication:            40 (0x28)
> 14D041          reserved:                      63 (0x3F) - (6bits)
> 14D041          lengthSizeMinusOne:            3 (0x3) - (2 bits)
> 14D042          reserved:                      7 (0x7) - (3 bits)
> 14D042          numOfSequenceParameterSets:    1 (0x01) - (5 bits)
> 14D043          seq_parameter_set (30 bytes)
> 14D043           sequenceParameterSetLength:   28 (0x001C)
> 14D045           nal_ref_idc:                  3 (0x3) - (2 bits)
> 14D045           nal_unit_type:                7 (0x7) - (5 bits)
> 14D046           profile_idc:                  100 (0x64)
> 14D047           constraint_sett_flags:        0 (0x00)
> 14D048           constraint_sett0_flag:        No
> 14D048           constraint_sett1_flag:        No
> 14D048           constraint_sett2_flag:        No
> 14D048           constraint_sett3_flag:        No
> 14D048           constraint_sett4_flag:        No
> 14D048           constraint_sett5_flag:        No
> 14D048           constraint_sett6_flag:        No
> 14D048           constraint_sett7_flag:        No
> 14D048           level_idc:                    40 (0x28)
> 14D049           seq_parameter_set_id:         0 (0x0)
> 14D049           high profile specific (1 bytes)
> 14D049            chroma_format_idc:           1 (0x1) - 4:2:0
> 14D049            bit_depth_luma_minus8:       0 (0x0)
> 14D049            bit_depth_chroma_minus8:     0 (0x0)
> 14D049            qpprime_y_zero_transform_bypass_flag: No
> 14D049            seq_scaling_matrix_present_flag: No
> 14D04A           log2_max_frame_num_minus4:    0 (0x0)
> 14D04A           pic_order_cnt_type:           0 (0x0)
> 14D04A           log2_max_pic_order_cnt_lsb_minus4: 2 (0x2)
> 14D04A           max_num_ref_frames:           3 (0x3)
> 14D04B           gaps_in_frame_num_value_allowed_flag: No
> 14D04B           pic_width_in_mbs_minus1:      119 (0x077)
> 14D04D           pic_height_in_map_units_minus1: 49 (0x031)
> 14D04E           frame_mbs_only_flag:          Yes
> 14D04E           direct_8x8_inference_flag:    Yes
> 14D04E           frame_cropping_flag:          No
> 14D04E           vui_parameters_present_flag (17 bytes)
> 14D04E            vui_parameters_present_flag: Yes
> 14D04E            aspect_ratio_info_present_flag (2 bytes)
> 14D04E             aspect_ratio_info_present_flag: Yes
> 14D04F             aspect_ratio_idc:           1 (0x01) - (8 bits) - 1.000
> 14D050            overscan_info_present_flag:  No
> 14D050            video_signal_type_present_flag (3 bytes)
> 14D050             video_signal_type_present_flag: Yes
> 14D050             video_format:               5 (0x5) - (3 bits) - 
> 14D050             video_full_range_flag:      0 (0x0) - (1 bits) - Limited
> 14D050             colour_description_present_flag (3 bytes)
> 14D050              colour_description_present_flag: Yes
> 14D050              colour_primaries:          1 (0x01) - (8 bits) - BT.709
> 14D051              transfer_characteristics:  1 (0x01) - (8 bits) - BT.709
> 14D052              matrix_coefficients:       1 (0x01) - (8 bits) - BT.709
> 14D053            chroma_loc_info_present_flag: No
> 14D054            timing_info_present_flag (8 bytes)
> 14D054             timing_info_present_flag:   Yes
> 14D054             num_units_in_tick:          1 (0x00000001) - (32 bits)
> 14D058             time_scale:                 48 (0x00000030) - (32 bits)
> 14D05C             fixed_frame_rate_flag:      Yes
> 14D05C            nal_hrd_parameters_present_flag: No
> 14D05C            vcl_hrd_parameters_present_flag: No
> 14D05C            pic_struct_present_flag:     No
> 14D05C            bitstream_restriction_flag (3 bytes)
> 14D05C             bitstream_restriction_flag: Yes
> 14D05C             motion_vectors_over_pic_boundaries_flag: Yes
> 14D05D             max_bytes_per_pic_denom:    0 (0x0)
> 14D05D             max_bits_per_mb_denom:      0 (0x0)
> 14D05D             log2_max_mv_length_horizontal: 11 (0x0B)
> 14D05E             log2_max_mv_length_vertical: 11 (0x0B)
> 14D05F             max_num_reorder_frames:     2 (0x2)
> 14D05F             max_dec_frame_buffering:    4 (0x4)
> 14D061          numOfPictureParameterSets:     1 (0x01)
> 14D062          pic_parameter_set (6 bytes)
> 14D062           pictureParameterSetLength:    5 (0x0005)
> 14D064           nal_ref_idc:                  3 (0x3) - (2 bits)
> 14D064           nal_unit_type:                8 (0x8) - (5 bits)
> 14D065           pic_parameter_set_id:         0 (0x0)
> 14D065           seq_parameter_set_id:         0 (0x0)
> 14D065           entropy_coding_mode_flag:     Yes
> 14D065           bottom_field_pic_order_in_frame_present_flag: No
> 14D065           num_slice_groups_minus1:      0 (0x0)
> 14D065           num_ref_idx_l0_default_active_minus1: 3 (0x3)
> 14D066           num_ref_idx_l1_default_active_minus1: 0 (0x0)
> 14D066           weighted_pred_flag:           No
> 14D066           weighted_bipred_idc:          2 (0x2) - (2 bits)
> 14D066           pic_init_qp_minus26:          0 (0x0)
> 14D067           pic_init_qs_minus26:          0 (0x0)
> 14D067           chroma_qp_index_offset:       0 (0x0)
> 14D067           deblocking_filter_control_present_flag: Yes
> 14D067           constrained_intra_pred_flag:  No
> 14D067           redundant_pic_cnt_present_flag: No
> 14D067           transform_8x8_mode_flag:      Yes
> 14D067           pic_scaling_matrix_present_flag: No
> 14D067           second_chroma_qp_index_offset: 0 (0x0)
> 14D068          -------------------------
> 14D068          ---   AVC, accepted   ---
> 14D068          -------------------------
> 14D069          reserved:                      63 (0x3F) - (6 bits)
> 14D069          chroma_format:                 1 (0x1) - (2 bits)
> 14D06A          reserved:                      31 (0x1F) - (5 bits)
> 14D06A          bit_depth_luma_minus8:         0 (0x0) - (3 bits)
> 14D06B          reserved:                      31 (0x1F) - (5 bits)
> 14D06B          bit_depth_chroma_minus8:       0 (0x0) - (3 bits)
> 14D06C          numOfSequenceParameterSetExt:  0 (0x00)
> 14D06D        Pixel Aspect Ratio (16 bytes)
> 14D06D         Header (8 bytes)
> 14D06D          Size:                          16 (0x00000010)
> 14D071          Name:                          pasp
> 14D075         hSpacing:                       1 (0x00000001)
> 14D079         vSpacing:                       1 (0x00000001)
> ```

<img src="assets/image-20240311160135670.png" alt="image-20240311160135670" /> 

<img src="assets/image-20240311160150234.png" alt="image-20240311160150234" /> 

2. 音频的stsd 

包含了音频相关的信息 , 比如采样率 , 通道数量等

<img src="assets/image-20240311155629542.png" alt="image-20240311155629542" /> 

<img src="assets/image-20240311160530793.png" alt="image-20240311160530793" /> 

<img src="assets/image-20240311160231596.png" alt="image-20240311160231596" /> 

## 4.2 stts

> ```tex
> "stts"存储了sample的duration,描述了sample时序的映射方法,我们通过它可以找到任何时间的sample。"stts"可以包含一个压缩的表来映射时间和sample序号,用其他的表来提供每个sample的长度和指针。表中每个条目提供了在同一个时间偏移量里面连续的sample序号,以及samples的偏移量。递增这些偏移量,就可以建立一个完整的time to sample表
> ```

> ```c++
> aligned(8) class TimeToSampleBox
>    extends FullBox('stts', version = 0,0) {
>    unsigned int(32)  entry_count;
>       int i;
>    for (i=0; i < entry_count; i++) {
>       unsigned int(32)  sample_count;
>       unsigned int(32)  sample_delta;
>    }
> }
> ```

Time-to-Sample Box , 定义每个sample时长。Time-To-Sample的table entry布局如下 : 

<img src="assets/image-20240311160709507.png" alt="image-20240311160709507" /> 

stts table entry布局  

- sample count : sample个数
- sample duration : sample持续时间

**$\color{red}{\mathbf{持续时间相同的连续sample可以放到⼀个entry⾥达到节省空间的目的}}$**

这⾥先给出来的是视频的 stts , Number of entries , **$\color{red}{\mathbf{这个参数需要注意并不是sample的个数\ , sample的实际数量需要将每个entry\ 的\ sample\ count\ 进行累加才是真正的sample个数}}$​​** 参考下面的数据为例子 sample total = 1+1+1+2+...+2+1

下面文本示例中 , 第1个sample时间为3720 , 单位用mdhd的time scale进行换算 , 比如视频的(Time scale)是90000 , 此时换算成秒为3720 ÷ 90000 = 0.0413333333333333秒 = 41.3333333333333ms

1. 视频stts内容

> ```tex
> 14D07D      Time to Sample (664 bytes)
> 14D07D       Header (8 bytes)
> 14D07D        Size:                            664 (0x00000298)
> 14D081        Name:                            stts
> 14D085       Version:                          0 (0x00)
> 14D086       Flags:                            0 (0x000000)
> 14D089       Number of entries:                81 (0x00000051)
> 14D08D       Sample Count:                     1 (0x00000001)
> 14D091       Sample Duration:                  3720 (0x00000E88)
> 14D095       Sample Count:                     1 (0x00000001)
> 14D099       Sample Duration:                  3780 (0x00000EC4)
> 14D09D       Sample Count:                     1 (0x00000001)
> 14D0A1       Sample Duration:                  3690 (0x00000E6A)
> 14D0A5       Sample Count:                     2 (0x00000002)
> 14D0A9       Sample Duration:                  3780 (0x00000EC4)
> 14D0AD       Sample Count:                     1 (0x00000001)
> 14D0B1       Sample Duration:                  3690 (0x00000E6A)
> 14D0B5       Sample Count:                     2 (0x00000002)
> 14D0B9       Sample Duration:                  3780 (0x00000EC4)
> 14D0BD       Sample Count:                     1 (0x00000001)
> 14D0C1       Sample Duration:                  3690 (0x00000E6A)
> 14D0C5       Sample Count:                     2 (0x00000002)
> 14D0C9       Sample Duration:                  3780 (0x00000EC4)
> 14D0CD       Sample Count:                     1 (0x00000001)
> 14D0D1       Sample Duration:                  3690 (0x00000E6A)
> 14D0D5       Sample Count:                     2 (0x00000002)
> 14D0D9       Sample Duration:                  3780 (0x00000EC4)
> 14D0DD       Sample Count:                     1 (0x00000001)
> 14D0E1       Sample Duration:                  3690 (0x00000E6A)
> 14D0E5       Sample Count:                     2 (0x00000002)
> 14D0E9       Sample Duration:                  3780 (0x00000EC4)
> 14D0ED       Sample Count:                     1 (0x00000001)
> 14D0F1       Sample Duration:                  3690 (0x00000E6A)
> 14D0F5       Sample Count:                     2 (0x00000002)
> 14D0F9       Sample Duration:                  3780 (0x00000EC4)
> 14D0FD       Sample Count:                     1 (0x00000001)
> 14D101       Sample Duration:                  3690 (0x00000E6A)
> 14D105       Sample Count:                     2 (0x00000002)
> 14D109       Sample Duration:                  3780 (0x00000EC4)
> 14D10D       Sample Count:                     1 (0x00000001)
> 14D111       Sample Duration:                  3690 (0x00000E6A)
> 14D115       Sample Count:                     2 (0x00000002)
> 14D119       Sample Duration:                  3780 (0x00000EC4)
> 14D11D       Sample Count:                     1 (0x00000001)
> 14D121       Sample Duration:                  3690 (0x00000E6A)
> 14D125       Sample Count:                     2 (0x00000002)
> 14D129       Sample Duration:                  3780 (0x00000EC4)
> 14D12D       Sample Count:                     1 (0x00000001)
> 14D131       Sample Duration:                  3690 (0x00000E6A)
> 14D135       Sample Count:                     2 (0x00000002)
> 14D139       Sample Duration:                  3780 (0x00000EC4)
> 14D13D       Sample Count:                     1 (0x00000001)
> 14D141       Sample Duration:                  3690 (0x00000E6A)
> 14D145       Sample Count:                     2 (0x00000002)
> 14D149       Sample Duration:                  3780 (0x00000EC4)
> 14D14D       Sample Count:                     1 (0x00000001)
> 14D151       Sample Duration:                  3690 (0x00000E6A)
> 14D155       Sample Count:                     2 (0x00000002)
> 14D159       Sample Duration:                  3780 (0x00000EC4)
> 14D15D       Sample Count:                     1 (0x00000001)
> 14D161       Sample Duration:                  3690 (0x00000E6A)
> 14D165       Sample Count:                     2 (0x00000002)
> 14D169       Sample Duration:                  3780 (0x00000EC4)
> 14D16D       Sample Count:                     1 (0x00000001)
> 14D171       Sample Duration:                  3690 (0x00000E6A)
> 14D175       Sample Count:                     2 (0x00000002)
> 14D179       Sample Duration:                  3780 (0x00000EC4)
> 14D17D       Sample Count:                     1 (0x00000001)
> 14D181       Sample Duration:                  3690 (0x00000E6A)
> 14D185       Sample Count:                     2 (0x00000002)
> 14D189       Sample Duration:                  3780 (0x00000EC4)
> 14D18D       Sample Count:                     1 (0x00000001)
> 14D191       Sample Duration:                  3690 (0x00000E6A)
> 14D195       Sample Count:                     2 (0x00000002)
> 14D199       Sample Duration:                  3780 (0x00000EC4)
> 14D19D       Sample Count:                     1 (0x00000001)
> 14D1A1       Sample Duration:                  3690 (0x00000E6A)
> 14D1A5       Sample Count:                     1 (0x00000001)
> 14D1A9       Sample Duration:                  3780 (0x00000EC4)
> 14D1AD       Sample Count:                     1 (0x00000001)
> 14D1B1       Sample Duration:                  3750 (0x00000EA6)
> 14D1B5       Sample Count:                     1 (0x00000001)
> 14D1B9       Sample Duration:                  3720 (0x00000E88)
> 14D1BD       Sample Count:                     2 (0x00000002)
> 14D1C1       Sample Duration:                  3780 (0x00000EC4)
> 14D1C5       Sample Count:                     1 (0x00000001)
> 14D1C9       Sample Duration:                  3690 (0x00000E6A)
> 14D1CD       Sample Count:                     2 (0x00000002)
> 14D1D1       Sample Duration:                  3780 (0x00000EC4)
> 14D1D5       Sample Count:                     1 (0x00000001)
> 14D1D9       Sample Duration:                  3690 (0x00000E6A)
> 14D1DD       Sample Count:                     2 (0x00000002)
> 14D1E1       Sample Duration:                  3780 (0x00000EC4)
> 14D1E5       Sample Count:                     1 (0x00000001)
> 14D1E9       Sample Duration:                  3690 (0x00000E6A)
> 14D1ED       Sample Count:                     2 (0x00000002)
> 14D1F1       Sample Duration:                  3780 (0x00000EC4)
> 14D1F5       Sample Count:                     1 (0x00000001)
> 14D1F9       Sample Duration:                  3690 (0x00000E6A)
> 14D1FD       Sample Count:                     2 (0x00000002)
> 14D201       Sample Duration:                  3780 (0x00000EC4)
> 14D205       Sample Count:                     1 (0x00000001)
> 14D209       Sample Duration:                  3690 (0x00000E6A)
> 14D20D       Sample Count:                     2 (0x00000002)
> 14D211       Sample Duration:                  3780 (0x00000EC4)
> 14D215       Sample Count:                     1 (0x00000001)
> 14D219       Sample Duration:                  3690 (0x00000E6A)
> 14D21D       Sample Count:                     2 (0x00000002)
> 14D221       Sample Duration:                  3780 (0x00000EC4)
> 14D225       Sample Count:                     1 (0x00000001)
> 14D229       Sample Duration:                  3690 (0x00000E6A)
> 14D22D       Sample Count:                     2 (0x00000002)
> 14D231       Sample Duration:                  3780 (0x00000EC4)
> 14D235       Sample Count:                     1 (0x00000001)
> 14D239       Sample Duration:                  3690 (0x00000E6A)
> 14D23D       Sample Count:                     2 (0x00000002)
> 14D241       Sample Duration:                  3780 (0x00000EC4)
> 14D245       Sample Count:                     1 (0x00000001)
> 14D249       Sample Duration:                  3690 (0x00000E6A)
> 14D24D       Sample Count:                     2 (0x00000002)
> 14D251       Sample Duration:                  3780 (0x00000EC4)
> 14D255       Sample Count:                     1 (0x00000001)
> 14D259       Sample Duration:                  3690 (0x00000E6A)
> 14D25D       Sample Count:                     2 (0x00000002)
> 14D261       Sample Duration:                  3780 (0x00000EC4)
> 14D265       Sample Count:                     1 (0x00000001)
> 14D269       Sample Duration:                  3690 (0x00000E6A)
> 14D26D       Sample Count:                     2 (0x00000002)
> 14D271       Sample Duration:                  3780 (0x00000EC4)
> 14D275       Sample Count:                     1 (0x00000001)
> 14D279       Sample Duration:                  3690 (0x00000E6A)
> 14D27D       Sample Count:                     2 (0x00000002)
> 14D281       Sample Duration:                  3780 (0x00000EC4)
> 14D285       Sample Count:                     1 (0x00000001)
> 14D289       Sample Duration:                  3690 (0x00000E6A)
> 14D28D       Sample Count:                     2 (0x00000002)
> 14D291       Sample Duration:                  3780 (0x00000EC4)
> 14D295       Sample Count:                     1 (0x00000001)
> 14D299       Sample Duration:                  3690 (0x00000E6A)
> 14D29D       Sample Count:                     2 (0x00000002)
> 14D2A1       Sample Duration:                  3780 (0x00000EC4)
> 14D2A5       Sample Count:                     1 (0x00000001)
> 14D2A9       Sample Duration:                  3690 (0x00000E6A)
> 14D2AD       Sample Count:                     2 (0x00000002)
> 14D2B1       Sample Duration:                  3780 (0x00000EC4)
> 14D2B5       Sample Count:                     1 (0x00000001)
> 14D2B9       Sample Duration:                  3750 (0x00000EA6)
> 14D2BD       Sample Count:                     1 (0x00000001)
> 14D2C1       Sample Duration:                  3720 (0x00000E88)
> 14D2C5       Sample Count:                     1 (0x00000001)
> 14D2C9       Sample Duration:                  3780 (0x00000EC4)
> 14D2CD       Sample Count:                     1 (0x00000001)
> 14D2D1       Sample Duration:                  3690 (0x00000E6A)
> 14D2D5       Sample Count:                     2 (0x00000002)
> 14D2D9       Sample Duration:                  3780 (0x00000EC4)
> 14D2DD       Sample Count:                     1 (0x00000001)
> 14D2E1       Sample Duration:                  3690 (0x00000E6A)
> 14D2E5       Sample Count:                     2 (0x00000002)
> 14D2E9       Sample Duration:                  3780 (0x00000EC4)
> 14D2ED       Sample Count:                     1 (0x00000001)
> 14D2F1       Sample Duration:                  3690 (0x00000E6A)
> 14D2F5       Sample Count:                     2 (0x00000002)
> 14D2F9       Sample Duration:                  3780 (0x00000EC4)
> 14D2FD       Sample Count:                     1 (0x00000001)
> 14D301       Sample Duration:                  3690 (0x00000E6A)
> 14D305       Sample Count:                     2 (0x00000002)
> 14D309       Sample Duration:                  3780 (0x00000EC4)
> 14D30D       Sample Count:                     1 (0x00000001)
> 14D311       Sample Duration:                  3750 (0x00000EA6)
> ```

<img src="assets/image-20240311171430578.png" alt="image-20240311171430578" /> 

2. 音频的stts

只是mdhd的 time scale 的差别 , 之前我们看到⾳频为44100 , 则计算第⼀个sample的时间 1024/44100=0.0232199546485261秒 = 23.2199546485261ms

> ```tex
> 14B4C4      Time to Sample (1048 bytes)
> 14B4C4       Header (8 bytes)
> 14B4C4        Size:                            1048 (0x00000418)
> 14B4C8        Name:                            stts
> 14B4CC       Version:                          0 (0x00)
> 14B4CD       Flags:                            0 (0x000000)
> 14B4D0       Number of entries:                129 (0x00000081)
> 14B4D4       Sample Count:                     1 (0x00000001)
> 14B4D8       Sample Duration:                  1024 (0x00000400)
> 14B4DC       Sample Count:                     1 (0x00000001)
> 14B4E0       Sample Duration:                  1025 (0x00000401)
> 14B4E4       Sample Count:                     2 (0x00000002)
> 14B4E8       Sample Duration:                  1024 (0x00000400)
> 14B4EC       Sample Count:                     1 (0x00000001)
> 14B4F0       Sample Duration:                  1023 (0x000003FF)
> 14B4F4       Sample Count:                     1 (0x00000001)
> 14B4F8       Sample Duration:                  1024 (0x00000400)
> 14B4FC       Sample Count:                     1 (0x00000001)
> 14B500       Sample Duration:                  1025 (0x00000401)
> 14B504       Sample Count:                     1 (0x00000001)
> 14B508       Sample Duration:                  1024 (0x00000400)
> 14B50C       Sample Count:                     1 (0x00000001)
> 14B510       Sample Duration:                  1023 (0x000003FF)
> 14B514       Sample Count:                     2 (0x00000002)
> 14B518       Sample Duration:                  1024 (0x00000400)
> 14B51C       Sample Count:                     1 (0x00000001)
> 14B520       Sample Duration:                  1025 (0x00000401)
> 14B524       Sample Count:                     1 (0x00000001)
> 14B528       Sample Duration:                  1024 (0x00000400)
> 14B52C       Sample Count:                     1 (0x00000001)
> 14B530       Sample Duration:                  1023 (0x000003FF)
> 14B534       Sample Count:                     2 (0x00000002)
> 14B538       Sample Duration:                  1024 (0x00000400)
> 14B53C       Sample Count:                     1 (0x00000001)
> 14B540       Sample Duration:                  1025 (0x00000401)
> 14B544       Sample Count:                     1 (0x00000001)
> 14B548       Sample Duration:                  1024 (0x00000400)
> 14B54C       Sample Count:                     1 (0x00000001)
> 14B550       Sample Duration:                  1023 (0x000003FF)
> 14B554       Sample Count:                     2 (0x00000002)
> 14B558       Sample Duration:                  1024 (0x00000400)
> 14B55C       Sample Count:                     1 (0x00000001)
> 14B560       Sample Duration:                  1025 (0x00000401)
> 14B564       Sample Count:                     1 (0x00000001)
> 14B568       Sample Duration:                  1024 (0x00000400)
> 14B56C       Sample Count:                     1 (0x00000001)
> 14B570       Sample Duration:                  1023 (0x000003FF)
> 14B574       Sample Count:                     1 (0x00000001)
> 14B578       Sample Duration:                  1024 (0x00000400)
> 14B57C       Sample Count:                     1 (0x00000001)
> 14B580       Sample Duration:                  1025 (0x00000401)
> 14B584       Sample Count:                     2 (0x00000002)
> 14B588       Sample Duration:                  1024 (0x00000400)
> 14B58C       Sample Count:                     1 (0x00000001)
> 14B590       Sample Duration:                  1023 (0x000003FF)
> 14B594       Sample Count:                     1 (0x00000001)
> 14B598       Sample Duration:                  1024 (0x00000400)
> 14B59C       Sample Count:                     1 (0x00000001)
> 14B5A0       Sample Duration:                  1025 (0x00000401)
> 14B5A4       Sample Count:                     2 (0x00000002)
> 14B5A8       Sample Duration:                  1024 (0x00000400)
> 14B5AC       Sample Count:                     1 (0x00000001)
> 14B5B0       Sample Duration:                  1023 (0x000003FF)
> 14B5B4       Sample Count:                     1 (0x00000001)
> 14B5B8       Sample Duration:                  1024 (0x00000400)
> 14B5BC       Sample Count:                     1 (0x00000001)
> 14B5C0       Sample Duration:                  1025 (0x00000401)
> 14B5C4       Sample Count:                     2 (0x00000002)
> 14B5C8       Sample Duration:                  1024 (0x00000400)
> 14B5CC       Sample Count:                     1 (0x00000001)
> 14B5D0       Sample Duration:                  1023 (0x000003FF)
> 14B5D4       Sample Count:                     1 (0x00000001)
> 14B5D8       Sample Duration:                  1024 (0x00000400)
> 14B5DC       Sample Count:                     1 (0x00000001)
> 14B5E0       Sample Duration:                  1025 (0x00000401)
> 14B5E4       Sample Count:                     2 (0x00000002)
> 14B5E8       Sample Duration:                  1024 (0x00000400)
> 14B5EC       Sample Count:                     1 (0x00000001)
> 14B5F0       Sample Duration:                  1023 (0x000003FF)
> 14B5F4       Sample Count:                     1 (0x00000001)
> 14B5F8       Sample Duration:                  1024 (0x00000400)
> 14B5FC       Sample Count:                     1 (0x00000001)
> 14B600       Sample Duration:                  1025 (0x00000401)
> 14B604       Sample Count:                     2 (0x00000002)
> 14B608       Sample Duration:                  1024 (0x00000400)
> 14B60C       Sample Count:                     1 (0x00000001)
> 14B610       Sample Duration:                  1023 (0x000003FF)
> 14B614       Sample Count:                     1 (0x00000001)
> 14B618       Sample Duration:                  1024 (0x00000400)
> 14B61C       Sample Count:                     1 (0x00000001)
> 14B620       Sample Duration:                  1025 (0x00000401)
> 14B624       Sample Count:                     2 (0x00000002)
> 14B628       Sample Duration:                  1024 (0x00000400)
> 14B62C       Sample Count:                     1 (0x00000001)
> 14B630       Sample Duration:                  1023 (0x000003FF)
> 14B634       Sample Count:                     1 (0x00000001)
> 14B638       Sample Duration:                  1024 (0x00000400)
> 14B63C       Sample Count:                     1 (0x00000001)
> 14B640       Sample Duration:                  1025 (0x00000401)
> 14B644       Sample Count:                     50 (0x00000032)
> 14B648       Sample Duration:                  1024 (0x00000400)
> 14B64C       Sample Count:                     1 (0x00000001)
> 14B650       Sample Duration:                  1023 (0x000003FF)
> 14B654       Sample Count:                     2 (0x00000002)
> 14B658       Sample Duration:                  1024 (0x00000400)
> 14B65C       Sample Count:                     1 (0x00000001)
> 14B660       Sample Duration:                  1025 (0x00000401)
> 14B664       Sample Count:                     1 (0x00000001)
> 14B668       Sample Duration:                  1024 (0x00000400)
> 14B66C       Sample Count:                     1 (0x00000001)
> 14B670       Sample Duration:                  1023 (0x000003FF)
> 14B674       Sample Count:                     2 (0x00000002)
> 14B678       Sample Duration:                  1024 (0x00000400)
> 14B67C       Sample Count:                     1 (0x00000001)
> 14B680       Sample Duration:                  1025 (0x00000401)
> 14B684       Sample Count:                     1 (0x00000001)
> 14B688       Sample Duration:                  1024 (0x00000400)
> 14B68C       Sample Count:                     1 (0x00000001)
> 14B690       Sample Duration:                  1023 (0x000003FF)
> 14B694       Sample Count:                     2 (0x00000002)
> 14B698       Sample Duration:                  1024 (0x00000400)
> 14B69C       Sample Count:                     1 (0x00000001)
> 14B6A0       Sample Duration:                  1025 (0x00000401)
> 14B6A4       Sample Count:                     1 (0x00000001)
> 14B6A8       Sample Duration:                  1024 (0x00000400)
> 14B6AC       Sample Count:                     1 (0x00000001)
> 14B6B0       Sample Duration:                  1023 (0x000003FF)
> 14B6B4       Sample Count:                     1 (0x00000001)
> 14B6B8       Sample Duration:                  1024 (0x00000400)
> 14B6BC       Sample Count:                     1 (0x00000001)
> 14B6C0       Sample Duration:                  1025 (0x00000401)
> 14B6C4       Sample Count:                     2 (0x00000002)
> 14B6C8       Sample Duration:                  1024 (0x00000400)
> 14B6CC       Sample Count:                     1 (0x00000001)
> 14B6D0       Sample Duration:                  1023 (0x000003FF)
> 14B6D4       Sample Count:                     1 (0x00000001)
> 14B6D8       Sample Duration:                  1024 (0x00000400)
> 14B6DC       Sample Count:                     1 (0x00000001)
> 14B6E0       Sample Duration:                  1025 (0x00000401)
> 14B6E4       Sample Count:                     2 (0x00000002)
> 14B6E8       Sample Duration:                  1024 (0x00000400)
> 14B6EC       Sample Count:                     1 (0x00000001)
> 14B6F0       Sample Duration:                  1023 (0x000003FF)
> 14B6F4       Sample Count:                     1 (0x00000001)
> 14B6F8       Sample Duration:                  1024 (0x00000400)
> 14B6FC       Sample Count:                     1 (0x00000001)
> 14B700       Sample Duration:                  1025 (0x00000401)
> 14B704       Sample Count:                     2 (0x00000002)
> 14B708       Sample Duration:                  1024 (0x00000400)
> 14B70C       Sample Count:                     1 (0x00000001)
> 14B710       Sample Duration:                  1023 (0x000003FF)
> 14B714       Sample Count:                     1 (0x00000001)
> 14B718       Sample Duration:                  1024 (0x00000400)
> 14B71C       Sample Count:                     1 (0x00000001)
> 14B720       Sample Duration:                  1025 (0x00000401)
> 14B724       Sample Count:                     2 (0x00000002)
> 14B728       Sample Duration:                  1024 (0x00000400)
> 14B72C       Sample Count:                     1 (0x00000001)
> 14B730       Sample Duration:                  1023 (0x000003FF)
> 14B734       Sample Count:                     1 (0x00000001)
> 14B738       Sample Duration:                  1024 (0x00000400)
> 14B73C       Sample Count:                     1 (0x00000001)
> 14B740       Sample Duration:                  1025 (0x00000401)
> 14B744       Sample Count:                     2 (0x00000002)
> 14B748       Sample Duration:                  1024 (0x00000400)
> 14B74C       Sample Count:                     1 (0x00000001)
> 14B750       Sample Duration:                  1023 (0x000003FF)
> 14B754       Sample Count:                     1 (0x00000001)
> 14B758       Sample Duration:                  1024 (0x00000400)
> 14B75C       Sample Count:                     1 (0x00000001)
> 14B760       Sample Duration:                  1025 (0x00000401)
> 14B764       Sample Count:                     2 (0x00000002)
> 14B768       Sample Duration:                  1024 (0x00000400)
> 14B76C       Sample Count:                     1 (0x00000001)
> 14B770       Sample Duration:                  1023 (0x000003FF)
> 14B774       Sample Count:                     1 (0x00000001)
> 14B778       Sample Duration:                  1024 (0x00000400)
> 14B77C       Sample Count:                     1 (0x00000001)
> 14B780       Sample Duration:                  1025 (0x00000401)
> 14B784       Sample Count:                     1 (0x00000001)
> 14B788       Sample Duration:                  1024 (0x00000400)
> 14B78C       Sample Count:                     1 (0x00000001)
> 14B790       Sample Duration:                  1023 (0x000003FF)
> 14B794       Sample Count:                     2 (0x00000002)
> 14B798       Sample Duration:                  1024 (0x00000400)
> 14B79C       Sample Count:                     1 (0x00000001)
> 14B7A0       Sample Duration:                  1025 (0x00000401)
> 14B7A4       Sample Count:                     1 (0x00000001)
> 14B7A8       Sample Duration:                  1024 (0x00000400)
> 14B7AC       Sample Count:                     1 (0x00000001)
> 14B7B0       Sample Duration:                  1023 (0x000003FF)
> 14B7B4       Sample Count:                     2 (0x00000002)
> 14B7B8       Sample Duration:                  1024 (0x00000400)
> 14B7BC       Sample Count:                     1 (0x00000001)
> 14B7C0       Sample Duration:                  1025 (0x00000401)
> 14B7C4       Sample Count:                     1 (0x00000001)
> 14B7C8       Sample Duration:                  1024 (0x00000400)
> 14B7CC       Sample Count:                     1 (0x00000001)
> 14B7D0       Sample Duration:                  1023 (0x000003FF)
> 14B7D4       Sample Count:                     2 (0x00000002)
> 14B7D8       Sample Duration:                  1024 (0x00000400)
> 14B7DC       Sample Count:                     1 (0x00000001)
> 14B7E0       Sample Duration:                  1025 (0x00000401)
> 14B7E4       Sample Count:                     1 (0x00000001)
> 14B7E8       Sample Duration:                  1024 (0x00000400)
> 14B7EC       Sample Count:                     1 (0x00000001)
> 14B7F0       Sample Duration:                  1023 (0x000003FF)
> 14B7F4       Sample Count:                     1 (0x00000001)
> 14B7F8       Sample Duration:                  1024 (0x00000400)
> 14B7FC       Sample Count:                     1 (0x00000001)
> 14B800       Sample Duration:                  1025 (0x00000401)
> 14B804       Sample Count:                     2 (0x00000002)
> 14B808       Sample Duration:                  1024 (0x00000400)
> 14B80C       Sample Count:                     1 (0x00000001)
> 14B810       Sample Duration:                  1023 (0x000003FF)
> 14B814       Sample Count:                     1 (0x00000001)
> 14B818       Sample Duration:                  1024 (0x00000400)
> 14B81C       Sample Count:                     1 (0x00000001)
> 14B820       Sample Duration:                  1025 (0x00000401)
> 14B824       Sample Count:                     2 (0x00000002)
> 14B828       Sample Duration:                  1024 (0x00000400)
> 14B82C       Sample Count:                     1 (0x00000001)
> 14B830       Sample Duration:                  1023 (0x000003FF)
> 14B834       Sample Count:                     1 (0x00000001)
> 14B838       Sample Duration:                  1024 (0x00000400)
> 14B83C       Sample Count:                     1 (0x00000001)
> 14B840       Sample Duration:                  1025 (0x00000401)
> 14B844       Sample Count:                     2 (0x00000002)
> 14B848       Sample Duration:                  1024 (0x00000400)
> 14B84C       Sample Count:                     1 (0x00000001)
> 14B850       Sample Duration:                  1023 (0x000003FF)
> 14B854       Sample Count:                     1 (0x00000001)
> 14B858       Sample Duration:                  1024 (0x00000400)
> 14B85C       Sample Count:                     1 (0x00000001)
> 14B860       Sample Duration:                  1025 (0x00000401)
> 14B864       Sample Count:                     2 (0x00000002)
> 14B868       Sample Duration:                  1024 (0x00000400)
> 14B86C       Sample Count:                     1 (0x00000001)
> 14B870       Sample Duration:                  1023 (0x000003FF)
> 14B874       Sample Count:                     1 (0x00000001)
> 14B878       Sample Duration:                  1024 (0x00000400)
> 14B87C       Sample Count:                     1 (0x00000001)
> 14B880       Sample Duration:                  1025 (0x00000401)
> 14B884       Sample Count:                     2 (0x00000002)
> 14B888       Sample Duration:                  1024 (0x00000400)
> 14B88C       Sample Count:                     1 (0x00000001)
> 14B890       Sample Duration:                  1023 (0x000003FF)
> 14B894       Sample Count:                     1 (0x00000001)
> 14B898       Sample Duration:                  1024 (0x00000400)
> 14B89C       Sample Count:                     1 (0x00000001)
> 14B8A0       Sample Duration:                  1025 (0x00000401)
> 14B8A4       Sample Count:                     2 (0x00000002)
> 14B8A8       Sample Duration:                  1024 (0x00000400)
> 14B8AC       Sample Count:                     1 (0x00000001)
> 14B8B0       Sample Duration:                  1023 (0x000003FF)
> 14B8B4       Sample Count:                     1 (0x00000001)
> 14B8B8       Sample Duration:                  1024 (0x00000400)
> 14B8BC       Sample Count:                     1 (0x00000001)
> 14B8C0       Sample Duration:                  1025 (0x00000401)
> 14B8C4       Sample Count:                     11 (0x0000000B)
> 14B8C8       Sample Duration:                  1024 (0x00000400)
> 14B8CC       Sample Count:                     1 (0x00000001)
> 14B8D0       Sample Duration:                  1023 (0x000003FF)
> 14B8D4       Sample Count:                     1 (0x00000001)
> 14B8D8       Sample Duration:                  1024 (0x00000400)
> ```

<img src="assets/image-20240311171450465.png" alt="image-20240311171450465" /> 

## 4.3 stss

> ```
> "stss"确定media中的关键帧。对于压缩媒体数据,关键帧是一系列压缩序列的开始帧,其解压缩时不依赖以前的帧,而后续帧的解压缩将依赖于这个关键帧。“stss”可以非常紧凑的标记媒体内的随机存取点,它包含一个sample序号表,表内的每一项严格按照sample的序号排列，说明了媒体中的哪一个sample是关键帧。如果此表不存在,说明每一个sample都是一个关键帧,是一个随机存取点
> ```

**$\color{red}{\mathbf{Sync\ Sample\ Box}}$** (只针对视频) , 同步sample表 , 存放关键帧列表 , 关键帧是为了⽀持随机访问

stss的table entry布局如下 : 

<img src="assets/image-20240311171052113.png" alt="image-20240311171052113" /> 

stss table entry布局 

下文示例中 , 该视频track有3个关键帧

> ```tex
> 14D315      Sync Sample (28 bytes)
> 14D315       Header (8 bytes)
> 14D315        Size:                            28 (0x0000001C)
> 14D319        Name:                            stss
> 14D31D       Version:                          0 (0x00)
> 14D31E       Flags:                            0 (0x000000)
> 14D321       entry-count:                      3 (0x00000003)
> 14D331      Composition Time To Sample (952 bytes)
> 14D331       Header (8 bytes)
> 14D331        Size:                            952 (0x000003B8)
> 14D335        Name:                            ctts
> 14D339       Version:                          0 (0x00)
> 14D33A       Flags:                            0 (0x000000)
> 14D33D       entry_count:                      117 (0x00000075)
> ```

<img src="assets/image-20240311172101843.png" alt="image-20240311172101843" /> 

## 4.4 stsc

> ```c++
> aligned(8) class SampleToChunkBox
> extends FullBox(‘stsc’, version = 0, 0) { 
>     unsigned int(32) entry_count;
>     for (i=1; i u entry_count; i++) {
>     unsigned int(32) first_chunk;
>     unsigned int(32) samples_per_chunk; 
>     unsigned int(32) sample_description_index;
>     } 
> }
> ```

> ```tex
> 用chunk组织sample可以方便优化数据获取,一个thunk包含一个或多个sample。"stsc"中用一个表描述了sample与chunk的映射关系,查看这张表就可以找到包含指定sample的chunk,从而找到这个sample
> ```

Sample-To-Chunk Box , sample-chunk映射表。上⽂提到mp4通常把sample封装到chunk中 , 一个chunk可能会包含⼀个或者几个sample

Sample-To-Chunk Atom的table entry布局如下图所示 : 

<img src="assets/image-20240311172737766.png" alt="image-20240311172737766" /> 

stsc table entry布局

- First chunk : 每一个 entry 开始的 chunk 位置
- Samples per chunk : 每一个 chunk 里面包含多少的 sample
- sample_description_index : 每一个 sample 的描述。一般可以默认设置为1

来个补充说明(可能对上面解释很迷惑,以下说明可以帮到你) : 

> ```tex
> 这3个字段实际上决定了一个MP4中有多少个chunks,每个chunks有多少个samples。
> 这里重复说明一下chunk和sample的相关概念,在MP4文件中,最小的基本单位是Chunk而不是 Sample
> 
> sample:包含最小单元数据的slice,里面有实际的NAL数据
> chunk:里面包含的是一个一个的sample,为了是优化数据的读取,让I/O更有效率
> 
> 在 MP4 中最小的单位是 chunks,那么通过 stco 中定义的 chunk_offsets 字段,它描述的就是 chunks 在 mdat 中的位置。每一个 stco chunk_offset 就对应于 某一个 index 的 chunks。那么,first_chunk 就是用来定义该 chunk entry开始的位置
> 
> stsc 不需要对每一个 chunk 进行定义,因为 stsc 是定义一整个 entry
> 即:如果他们的 samples_per_chunk,sample_description_index 不变的话,那么后续的 chunks 都是用一样的模式
> 
> 如果你的 stsc 只有:
> first_chunk:1
> samples_per_chunk:4
> sample_description_index:1
> 
> 从第一个 chunk 开始,每通过切分 4 个 sample 划分为一个 chunk,并且每个 sample 的表述信息都是1。它会按照这样划分方法一直持续到最后。当然,如果你的 sample 最后不能被 4 整除,最后的几段 sample 就会当做特例进行处理
> 
> 通常情况下,stsc 的值是不一样的:
> first_chunk:1,2,5,6
> samples_per_chunk:2,1,2,1
> sample_description_index:1,1,1,1
> 
> 按照上面的情况就是,第 1 个 chunk 包含 2 个 samples。第 2-4 个 chunk 包含 1 个 sample,第 5 个 chunk 包含两个 chunk,第 6 个到最后一个 chunk 包含一个 sample。
> ```

下图示例中 , 可以看到该 **视频track** 一共有1个stsc表项 , chunk序列1-x , 每个chunk包含⼀个sample。这里则说明每个chunk里面只有⼀个sample (⼀个chunk是可以有多个sample)

<img src="assets/image-20240311173311179.png" alt="image-20240311173311179" /> 

 下图是音频的stsc的示例 

<img src="assets/image-20240311174058991.png" alt="image-20240311174058991" /> 

> ```tex
> chunk 1~84 的每个chunk包含1个samples
> chunk 85 包含2个samples
> chunk 86~88 的每个chunk包含1个samples
> chunk 89 包含2个samples
> chunk 90 包含1个samples
> ```

## 4.5 stsz

> ```c++
> aligned(8) class SampleSizeBox extends FullBox(‘stsz’, version = 0, 0) { 
> unsigned int(32) sample_size;
> unsigned int(32) sample_count;
> if (sample_size==0) {
>     for (i=1; i <= sample_count; i++) {
>           unsigned int(32)  entry_size;
>     } 
>     }
> }
> ```

> ```tex
> "stsz"定义了每个sample的大小,包含了媒体中全部sample的数目和一张给出每个sample大小的表。这个box相对来说体积是比较大的。
> ```

Sample Size Box , 指定了每个sample的size。Sample Size Atom包含两sample总数和⼀张包含了每个sample size的表

sample size 表的entry布局如下图 : 

 <img src="./assets/image-20240311220714614.png" alt="image-20240311220714614" />

stsz table entry布局

该视频流⼀共有117个sample , 第1个sample⼤⼩为42072字节 , 第2个sample⼤⼩为7354个字节

> ```tex
> 14D705      Sample Size (488 bytes)
> 14D705       Header (8 bytes)
> 14D705        Size:                            488 (0x000001E8)
> 14D709        Name:                            stsz
> 14D70D       Version:                          0 (0x00)
> 14D70E       Flags:                            0 (0x000000)
> 14D711       Sample Size:                      0 (0x00000000)
> 14D715       Number of entries:                117 (0x00000075)
> ```

<img src="./assets/image-20240311222800979.png" alt="image-20240311222800979" /> 

音频流跟视频流的布局一样 , 这里不列出

## 4.6 stco

> ```tex
> "stco" 定义了每个chunk在媒体流中的位置。位置有两种可能,32位的和64位的,后者对非常大的电影很有用。在一个表中只会有一种可能,这个位置是在整个文件中的,而不是在任何box中的,这样做就可以直接在文件中找到媒体数据,而不用解释box。需要注意的是一旦前面的box有了任何改变,这张表都要重新建立,因为位置信息已经改变了
> 
> stco 有两种形式,如果你的视频过大的话,就有可能造成 chunkoffset 超过 32bit 的限制。所以,这里针对大 Video 额外创建了一个 co64 的 Box。它的功效等价于 stco，也是用来表示 sample 在 mdat box 中的位置。只是里面 chunk_offset 是 64bit 的
> ```

> ```c++
> aligned(8) class ChunkOffsetBox
> extends FullBox(‘stco’, version = 0, 0) { 
> unsigned int(32) entry_count;
> for (i=1; i u entry_count; i++) {
>       unsigned int(32)  chunk_offset;
>    }
> }
> 
> aligned(8) class ChunkLargeOffsetBox extends FullBox(‘co64’, version = 0, 0) { 
> unsigned int(32) entry_count;
> for (i=1; i u entry_count; i++) {
>       unsigned int(64)  chunk_offset;
>    }
> }
> ```

Chunk Offset Box , 指定了每个chunk在⽂件中的位置 , 这个表是确定每个sample在⽂件中位置的关键。该表包含了chunk个数和⼀个包含每个chunk在⽂件中偏移位置的表

每个表项的内存布局如下 : 

 <img src="./assets/image-20240311225709820.png" alt="image-20240311225709820" />

stco table entry布局

需要注意 , 这⾥stco只是指定的每个chunk在⽂件中的偏移位置 , 并没有给出每个sample在⽂件中的偏移。想要获得每个sample的偏移位置 , 需要结合 Sample Size box(stsz) 和 Sample-To-Chunk(stsc) 计算后取得

该视频流第1个chunk在⽂件中的偏移为7544 , ⽽这⾥是每个chunk只有⼀个sample , 此时
第⼀个sample的起始位置就为7544->0x1D78 , 数据⼤⼩则参照stsz , 第⼀个sample size为172818

> ```tex
> 14D8ED      Chunk offset (484 bytes)
> 14D8ED       Header (8 bytes)
> 14D8ED        Size:                            484 (0x000001E4)
> 14D8F1        Name:                            stco
> 14D8F5       Version:                          0 (0x00)
> 14D8F6       Flags:                            0 (0x000000)
> 14D8F9       Number of entries:                117 (0x00000075)
> ```

<img src="./assets/image-20240311231624973.png" alt="image-20240311231624973" /> 

<img src="./assets/image-20240311233022673.png" alt="image-20240311233022673" /> 

## 4.7 ctts

ctts (Composition Time to Sample Box) 是用来描述合成时间和样本解码时间之间的偏移量(合成时间和解码时间的时间差) , 当音视频流需要进行合成时 , ctts提供了合成时间和样本解码时间之间的差异 , 通常只有 video track 才需要 ctts

> ```c++
> aligned(8) class CompositionOffsetBox extends FullBox(‘ctts’, version = 0, 0) { 
>     unsigned int(32) entry_count;
>       int i;
>    for (i=0; i < entry_count; i++) {
>       unsigned int(32)  sample_count;
>       unsigned int(32)  sample_offset;
>    }
> }
> ```

<img src="assets/image-20240313165904330.png" alt="image-20240313165904330" /> 

<img src="assets/image-20240313171923195.png" alt="image-20240313171923195" /> 

补充,来自chatgpt的回答: 合成偏移通常用于调整图像帧的显示时间 , 以实现特定的时间轴效果 , 例如延迟或提前显示图像帧。合成偏移在视频编码和解码中起着重要作用 , 可以用于控制视频帧的播放顺序和时间轴的调整。

# 5. 如何计算sample偏移位置

上⽂提到通过stco并不能直接获取某个sample的偏移位置 , 下⾯举例说明如何获取某⼀个pts对应的sample在⽂件中的位置

⼤体需要以下步骤 : 

1. 将pts转换到媒体对应的时间坐标系
2. 根据stts ((decoding) time-to-sample) 计算某个pts对应的sample序号
3. 根据stsc (sample-to-chunk) 计算sample序号存放在哪个chunk中
4. 根据stco (chunk offset) 获取对应chunk在⽂件中的偏移位置
5. 根据stsz获取sample在chunk内的偏移位置并加上第4步获取的偏移 , 计算出sample在⽂件中的偏移

例子 : 

> ```tex
> 想要获取3.64秒视频sample数据在⽂件中的位置,计算步骤
> 
> 1.根据time scale参数,将3.64秒转换为视频时间轴对应的3640000(假如时间刻度不为毫秒)
> 视频轨:time scale为90000,转成对应的时间戳为3.64秒 * 90000
> 
> 2.遍历累加下表所示stts所有项⽬,计算得到3640000位于第110个sample = 327600
> 
> 3.计算出多个sample_deltas叠加才到了327600,我们这⾥姑且按3780作为平均值计算,实际是
> 3720*1+3780*1+3690*1+3780*2 ...... 这样⼀直叠加进⾏。
> 327600/3780 = 86.66666666666667,取整为86
> 
> 4.查询下表所示stsc所有项⽬,计算得到第86个sample位于第86个chunk,并且在该chunk中位于第1
> 个sample(因为我们的码流是每个chunk对应了⼀个sample)
> 
> 5.查询下表所示stco所有项⽬,得到第86个chunk在⽂件中偏移位置为1004678。使⽤hexinator
> 
> 6.查询下表所示stsz所有项⽬,得到第86个sample的size为20934。计算得到3.64秒视频sample数据在⽂件中
> offset:1004678 + 0 = 1004678
> size:20934
> 
> 验证 : ⽤编辑器打开mp4⽂件,定位到⽂件偏移1004678位置，。
> 09分隔符,这⾥占⽤了6个字节,再看真正的数据区域,前4字节也为NALU的⻓度0x000051bc = 20924
> 总共占⽤的字节计算 4+2+4+20924 = 20934
> ```

# 6. 参考资料

[[扩展《整理mp4协议重点,将协议读薄》]](https://www.cnblogs.com/shakin/p/8543719.html)

[[MP4格式详解]](https://www.cnblogs.com/ranson7zop/p/7889272.html)

