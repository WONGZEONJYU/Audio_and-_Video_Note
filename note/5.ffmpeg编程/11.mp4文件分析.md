# 1. Introduction

mp4⽂件格式⼜被称为MPEG-4 Part 14 , 出⾃MPEG-4标准第14部分 .它是⼀种多媒体格式容器，⼴泛⽤于包装视频和⾳频数据流、海报、字幕和元数据等。(顺便⼀提 , ⽬前流⾏的视频编码格式AVC/H264定义在MPEG-4 Part 10)

mp4⽂件格式基于Apple公司的QuickTime格式 , 因此 , [QuickTime File Format Specification](https://developer.apple.com/documentation/quicktime-file-format#//apple_ref/doc/uid/TP40000939-CH202-TPXREF101)也可以作为我们研究mp4的重要参考

MP4⽂件结构的资料 : [link]() 

mp4box⼤杀器 : [link](https://gpac.github.io/mp4box.js/)

# 2. Overview

mp4⽂件由box组成 , 每个box分为Header和Data。其中Header部分包含了box的类型和⼤⼩ , Data包含了⼦box或者数据 , **$\color{red}{\mathbf{box可以嵌套⼦box}}$**

下图是⼀个典型mp4⽂件的基本结构 : 

<img src="./assets/image-20240309203113502.png" alt="image-20240309203113502" />  

MP4⽂件的基本组成单元是box , 也就是说MP4⽂件是由各种各样的box组成的 , 有parent box , 还有children box。因此 , 这些boxes之间存在⼀定的层次关系 , 总结如下表所示 , 表中标记出了各个box必选或可选特性 , √ 代表Box必选

| **$\color{red}{\mathbf{ftyp}}$** |                                  |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{file\ type and\ compatibility}}$<br />$\color{red}{\mathbf{⽂件类型和兼容性}}$ |
| -------------------------------- | -------------------------------- | -------------------------------- | -------------------------------- | -------------------------------- | ------------------------------------ | ---- | :----------------------------------------------------------- |
| pdin                             |                                  |                                  |                                  |                                  |                                      |      | progressive download information                             |
| **$\color{red}{\mathbf{moov}}$** |                                  |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{container\ for\ all\ the\ metadata}}$<br/>$\color{red}{\mathbf{所有元数据的容器}}$ |
|                                  | **$\color{red}{\mathbf{mvhd}}$** |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{movie\ header,\ overall\ declarations}}$<br/>$\color{red}{\mathbf{电影头\ ,\ 整体声明}}$ |
|                                  | **$\color{red}{\mathbf{trak}}$** |                                  |                                  |                                  |                                      | √    | $\color{red}{\mathbf{container\ for\ an\ individual\ track\ or\ stream}}$<br/>$\color{red}{\mathbf{单个轨或流的容器}}$ |
|                                  |                                  | **$\color{red}{\mathbf{tkhd}}$** |                                  |                                  |                                      | √    | $\color{red}{\mathbf{track\ header,\ overall\ information\ about\ the track}}$<br />$\color{red}{\mathbf{轨的头部\ ,\ 关于该轨的概括信息\ ,\ ⽐如视频宽⾼}}$ |
|                                  |                                  | tref                             |                                  |                                  |                                      | √    | track reference container                                    |
|                                  |                                  | edts                             |                                  |                                  |                                      | √    | edit list container                                          |
|                                  |                                  |                                  | elst                             |                                  |                                      | √    | an edit list                                                 |
|                                  |                                  | **$\color{red}{\mathbf{mdia}}$** |                                  |                                  |                                      | √    | $\color{red}{\mathbf{container\ for\ the\ media\ information\ in\ a\ track}}$<br/>$\color{red}{\mathbf{轨媒体信息的容器}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{mdhd}}$** |                                  |                                      | √    | **$\color{red}{\mathbf{media\ header,\ overall\ information\ about\ the\ media}}$**<br/>$\color{red}{\mathbf{媒体头\ ,\ 关于媒体的总体信息}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{hdlr}}$** |                                  |                                      | √    | $\color{red}{\mathbf{handler,\ declares\ the\ media\ (handler)\ type}}$<br />$\color{red}{\mathbf{媒体的播放过程信息}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{minf}}$** |                                  |                                      | √    | $\color{red}{\mathbf{media\ information\ container}}$<br/>$\color{red}{\mathbf{媒体信息容器}}$ |
|                                  |                                  |                                  |                                  | vmhd                             |                                      |      | video media header, overall information<br/>(video track only) |
|                                  |                                  |                                  |                                  | smhd                             |                                      |      | sound media header, overall information<br/>(sound track only) |
|                                  |                                  |                                  |                                  | hmhd                             |                                      |      | hint media header, overall information<br/>(hint track only) |
|                                  |                                  |                                  |                                  | nmhd                             |                                      |      | Null media header, overall information<br/>(some tracks only) |
|                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{dinf}}$** |                                      | √    | $\color{red}{\mathbf{data\ information\ box,\ container}}$<br/>$\color{red}{\mathbf{数据信息box\ ,\ 容器}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{dref}}$**     | √    | $\color{red}{\mathbf{data\ reference\ box,\ declares\ source(s)\ of\ media\ data\ in\ track}}$<br/>$\color{red}{\mathbf{如何定位媒体信息}}$ |
|                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stbl}}$** |                                      | √    | $\color{red}{\mathbf{sample\ table\ box,\ container\ for\ the\ time\ /\ space\ map}}$<br/>$\color{red}{\mathbf{包含了track中的sample的所有时间和位置信息\ ,\ 以及sample的编解码等信息。}}$<br />$\color{red}{\mathbf{利⽤这个表可以解析sample的时序、类型、⼤⼩以及在各⾃存储容器中的位置}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stsd}}$**     | √    | $\color{red}{\mathbf{sample\ descriptions\ (codec\ types\ ,\ initialization\ etc.)}}$<br/>$\color{red}{\mathbf{如果是视频\ ,\ 包含:\ 编码类型、宽⾼、长度等信息;}}$<br/>$\color{red}{\mathbf{如果是⾳频\ ,\ 包含:\ 声道、采样率等信息}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stts}}$**     | √    | **$\color{red}{\mathbf{(decoding)\ time-to-sample}}$**<br/>**$\color{red}{\mathbf{描述了sample时序的映射⽅法 , 我们可以通过它找到任何时间的sample}}$** |
|                                  |                                  |                                  |                                  |                                  | ctts                                 |      | (composition) time to sample                                 |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stsc}}$**     | √    | $\color{red}{\mathbf{sample-to-chunk,\ partial\ data-offset\ information}}$<br/>$\color{red}{\mathbf{⽤chunk组织sample可以⽅便优化数据获取 , }}$<br/>$\color{red}{\mathbf{⼀个chunk包含⼀个或多个sample}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{SkyBlue}{\mathbf{stsz}}$** |      | **$\color{SkyBlue}{\mathbf{sample\ sizes\ (framing)}}$**<br/>**$\color{SkyBlue}{\mathbf{每个sample的⼤⼩}}$**<br/>$\color{SkyBlue}{\mathbf{虽然这⾥没有打勾 , 但对于mp4还是⾮常必要的}}$ |
|                                  |                                  |                                  |                                  |                                  | stz2                                 |      | compact sample sizes (framing)                               |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stco}}$**     | √    | $\color{red}{\mathbf{chunk\ offset\ partial\ data-offset\ information}}$<br/>$\color{red}{\mathbf{定义了每个chunk在媒体流中的偏移位置}}$ |
|                                  |                                  |                                  |                                  |                                  | co6                                  |      | 64-bit chunk offset                                          |
|                                  |                                  |                                  |                                  |                                  | 4                                    |      |                                                              |
|                                  |                                  |                                  |                                  |                                  | **$\color{SkyBlue}{\mathbf{stss}}$** |      | $\color{SkyBlue}{\mathbf{sync\ sample\ table\ (random\ access points)}}$<br/>$\color{SkyBlue}{\mathbf{⽤于确定media中的关键帧}}$ |
|                                  |                                  |                                  |                                  |                                  | stsh                                 |      | shadow sync sample table                                     |
|                                  |                                  |                                  |                                  |                                  | padb                                 |      | sample padding bits                                          |
|                                  |                                  |                                  |                                  |                                  | stdp                                 |      | sample degradation priority                                  |
|                                  |                                  |                                  |                                  |                                  | sdtp                                 |      | independent and disposable samples                           |
|                                  |                                  |                                  |                                  |                                  | sbgp                                 |      | sample-to-group                                              |
|                                  |                                  |                                  |                                  |                                  | sgpd                                 |      | sample group description                                     |
|                                  |                                  |                                  |                                  |                                  | subs                                 |      | sub-sample information                                       |
|                                  | mvex                             |                                  |                                  |                                  |                                      |      | movie extends box                                            |
|                                  |                                  | mehd                             |                                  |                                  |                                      |      | movie extends header box                                     |
|                                  |                                  | trex                             |                                  |                                  |                                      | √    | track extends defaults                                       |
|                                  | ipmc                             |                                  |                                  |                                  |                                      |      | IPMP Control Box                                             |
| moof                             |                                  |                                  |                                  |                                  |                                      |      | movie fragment                                               |
|                                  | mfhd                             |                                  |                                  |                                  |                                      | √    | movie fragment header                                        |
|                                  | traf                             |                                  |                                  |                                  |                                      |      | track fragment                                               |
|                                  |                                  | tfhd                             |                                  |                                  |                                      | √    | track fragment header                                        |
|                                  |                                  | trun                             |                                  |                                  |                                      |      | track fragment run                                           |
|                                  |                                  | sdtp                             |                                  |                                  |                                      |      | independent and disposable samples                           |
|                                  |                                  | sbgp                             |                                  |                                  |                                      |      | sample-to-group                                              |
|                                  |                                  | subs                             |                                  |                                  |                                      |      | sub-sample information                                       |
| mfra                             |                                  |                                  |                                  |                                  |                                      |      | movie fragment random access                                 |
|                                  | tfra                             |                                  |                                  |                                  |                                      |      | track fragment random access                                 |
|                                  | mfro                             |                                  |                                  |                                  |                                      | √    | movie fragment random access offset                          |
| mdat                             |                                  |                                  |                                  |                                  |                                      |      | media data container                                         |
| free                             |                                  |                                  |                                  |                                  |                                      |      | free space                                                   |
| skip                             |                                  |                                  |                                  |                                  |                                      |      | free space                                                   |
|                                  | udta                             |                                  |                                  |                                  |                                      |      | user-data                                                    |
|                                  |                                  | cprt                             |                                  |                                  |                                      |      | copyright etc                                                |
| meta                             |                                  |                                  |                                  |                                  |                                      |      | metadata                                                     |
|                                  | hdlr                             |                                  |                                  |                                  |                                      | √    | handler, declares the metadata (handler) type                |
|                                  | dinf                             |                                  |                                  |                                  |                                      |      | data information box, container                              |
|                                  |                                  | dref                             |                                  |                                  |                                      |      | data reference box, declares source(s) of metadata items     |
|                                  | ipmc                             |                                  |                                  |                                  |                                      |      | IPMP Control Box                                             |
|                                  | iloc                             |                                  |                                  |                                  |                                      |      | item location                                                |
|                                  | ipro                             |                                  |                                  |                                  |                                      |      | item protection                                              |
|                                  |                                  | sinf                             |                                  |                                  |                                      |      | protection scheme information box                            |
|                                  |                                  |                                  | frma                             |                                  |                                      |      | original format box                                          |
|                                  |                                  |                                  | imif                             |                                  |                                      |      | IPMP Information box                                         |
|                                  |                                  |                                  | schm                             |                                  |                                      |      | scheme type box                                              |
|                                  |                                  |                                  | schi                             |                                  |                                      |      | scheme information box                                       |
|                                  | iinf                             |                                  |                                  |                                  |                                      |      | item information                                             |
|                                  | xml                              |                                  |                                  |                                  |                                      |      | XML container                                                |
|                                  | bxml                             |                                  |                                  |                                  |                                      |      | binary XML container                                         |
|                                  | pitm                             |                                  |                                  |                                  |                                      |      | primary item reference                                       |
|                                  | fiin                             |                                  |                                  |                                  |                                      |      | file delivery item information                               |
|                                  |                                  | paen                             |                                  |                                  |                                      |      | partition entry                                              |
|                                  |                                  |                                  | fpar                             |                                  |                                      |      | file partition                                               |
|                                  |                                  |                                  | fecr                             |                                  |                                      |      | FEC reservoir                                                |
|                                  |                                  | segr                             |                                  |                                  |                                      |      | file delivery session group                                  |
|                                  |                                  | gitn                             |                                  |                                  |                                      |      | group id to name                                             |
|                                  |                                  | tsel                             |                                  |                                  |                                      |      | track selection                                              |
| meco                             |                                  |                                  |                                  |                                  |                                      |      | additional metadata container                                |
|                                  | mere                             |                                  |                                  |                                  |                                      |      | metabox relation                                             |

本⽂使⽤mediainfo和mp4box进⾏分析

图中看到mp4⽂件由⼏个主要组成部分 , 下⾯以📎 2_audio_track_5s.mp4⽂件为分析案例

## 2.1 ftyp

File Type Box , ⼀般在⽂件的开始位置 , 描述的⽂件的版本、兼容协议等

> ```tex
> 000000 File Type (32 bytes)
> 000000  Header (8 bytes)
> 000000   Size:                                 32 (0x00000020)
> 000004   Name:                                 ftyp
> 000008  MajorBrand:                            isom
> 00000C  MajorBrandVersion:                     512 (0x00000200)
> 000010  CompatibleBrand:                       isom
> 000014  CompatibleBrand:                       iso2
> 000018  CompatibleBrand:                       avc1
> 00001C  CompatibleBrand:                       mp41
>                             ftyp内容
> ```

## 2.2 moov

Movie Box , 包含本⽂件中所有媒体数据的宏观描述信息以及每路媒体轨道的具体信息。⼀般位于放在⽂件末尾 , 但如果为了⽀持http边下载边播放则需要将moov提前。注意 , $\color{red}{\mathbf{当改变moov位置时,内部⼀些值需要重新计算}}$

> ```tex
> 14B2CE File header (10341 bytes)
> 14B2CE  Header (8 bytes)
> 14B2CE   Size:                                 10341 (0x00002865)
> 14B2D2   Name:                                 moov
> ```

