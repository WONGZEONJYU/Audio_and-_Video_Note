# 1. Introduction

mp4â½‚ä»¶æ ¼å¼â¼œè¢«ç§°ä¸ºMPEG-4 Part 14 , å‡ºâ¾ƒMPEG-4æ ‡å‡†ç¬¬14éƒ¨åˆ† .å®ƒæ˜¯â¼€ç§å¤šåª’ä½“æ ¼å¼å®¹å™¨ï¼Œâ¼´æ³›â½¤äºåŒ…è£…è§†é¢‘å’Œâ¾³é¢‘æ•°æ®æµã€æµ·æŠ¥ã€å­—å¹•å’Œå…ƒæ•°æ®ç­‰ã€‚(é¡ºä¾¿â¼€æ , â½¬å‰æµâ¾çš„è§†é¢‘ç¼–ç æ ¼å¼AVC/H264å®šä¹‰åœ¨MPEG-4 Part 10)

mp4â½‚ä»¶æ ¼å¼åŸºäºAppleå…¬å¸çš„QuickTimeæ ¼å¼ , å› æ­¤ , [QuickTime File Format Specification](https://developer.apple.com/documentation/quicktime-file-format#//apple_ref/doc/uid/TP40000939-CH202-TPXREF101)ä¹Ÿå¯ä»¥ä½œä¸ºæˆ‘ä»¬ç ”ç©¶mp4çš„é‡è¦å‚è€ƒ

MP4â½‚ä»¶ç»“æ„çš„èµ„æ–™ : [link]() 

mp4boxâ¼¤æ€å™¨ : [link](https://gpac.github.io/mp4box.js/)

# 2. Overview

mp4â½‚ä»¶ç”±boxç»„æˆ , æ¯ä¸ªboxåˆ†ä¸ºHeaderå’ŒDataã€‚å…¶ä¸­Headeréƒ¨åˆ†åŒ…å«äº†boxçš„ç±»å‹å’Œâ¼¤â¼© , DataåŒ…å«äº†â¼¦boxæˆ–è€…æ•°æ® , **$\color{red}{\mathbf{boxå¯ä»¥åµŒå¥—â¼¦box}}$**

ä¸‹å›¾æ˜¯â¼€ä¸ªå…¸å‹mp4â½‚ä»¶çš„åŸºæœ¬ç»“æ„ : 

<img src="./assets/image-20240309203113502.png" alt="image-20240309203113502" />  

MP4â½‚ä»¶çš„åŸºæœ¬ç»„æˆå•å…ƒæ˜¯box , ä¹Ÿå°±æ˜¯è¯´MP4â½‚ä»¶æ˜¯ç”±å„ç§å„æ ·çš„boxç»„æˆçš„ , æœ‰parent box , è¿˜æœ‰children boxã€‚å› æ­¤ , è¿™äº›boxesä¹‹é—´å­˜åœ¨â¼€å®šçš„å±‚æ¬¡å…³ç³» , æ€»ç»“å¦‚ä¸‹è¡¨æ‰€ç¤º , è¡¨ä¸­æ ‡è®°å‡ºäº†å„ä¸ªboxå¿…é€‰æˆ–å¯é€‰ç‰¹æ€§ , âˆš ä»£è¡¨Boxå¿…é€‰

| **$\color{red}{\mathbf{ftyp}}$** |                                  |                                  |                                  |                                  |                                      | âˆš    | $\color{red}{\mathbf{file\ type and\ compatibility}}$<br />$\color{red}{\mathbf{â½‚ä»¶ç±»å‹å’Œå…¼å®¹æ€§}}$ |
| -------------------------------- | -------------------------------- | -------------------------------- | -------------------------------- | -------------------------------- | ------------------------------------ | ---- | :----------------------------------------------------------- |
| pdin                             |                                  |                                  |                                  |                                  |                                      |      | progressive download information                             |
| **$\color{red}{\mathbf{moov}}$** |                                  |                                  |                                  |                                  |                                      | âˆš    | $\color{red}{\mathbf{container\ for\ all\ the\ metadata}}$<br/>$\color{red}{\mathbf{æ‰€æœ‰å…ƒæ•°æ®çš„å®¹å™¨}}$ |
|                                  | **$\color{red}{\mathbf{mvhd}}$** |                                  |                                  |                                  |                                      | âˆš    | $\color{red}{\mathbf{movie\ header,\ overall\ declarations}}$<br/>$\color{red}{\mathbf{ç”µå½±å¤´\ ,\ æ•´ä½“å£°æ˜}}$ |
|                                  | **$\color{red}{\mathbf{trak}}$** |                                  |                                  |                                  |                                      | âˆš    | $\color{red}{\mathbf{container\ for\ an\ individual\ track\ or\ stream}}$<br/>$\color{red}{\mathbf{å•ä¸ªè½¨æˆ–æµçš„å®¹å™¨}}$ |
|                                  |                                  | **$\color{red}{\mathbf{tkhd}}$** |                                  |                                  |                                      | âˆš    | $\color{red}{\mathbf{track\ header,\ overall\ information\ about\ the track}}$<br />$\color{red}{\mathbf{è½¨çš„å¤´éƒ¨\ ,\ å…³äºè¯¥è½¨çš„æ¦‚æ‹¬ä¿¡æ¯\ ,\ â½å¦‚è§†é¢‘å®½â¾¼}}$ |
|                                  |                                  | tref                             |                                  |                                  |                                      | âˆš    | track reference container                                    |
|                                  |                                  | edts                             |                                  |                                  |                                      | âˆš    | edit list container                                          |
|                                  |                                  |                                  | elst                             |                                  |                                      | âˆš    | an edit list                                                 |
|                                  |                                  | **$\color{red}{\mathbf{mdia}}$** |                                  |                                  |                                      | âˆš    | $\color{red}{\mathbf{container\ for\ the\ media\ information\ in\ a\ track}}$<br/>$\color{red}{\mathbf{è½¨åª’ä½“ä¿¡æ¯çš„å®¹å™¨}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{mdhd}}$** |                                  |                                      | âˆš    | **$\color{red}{\mathbf{media\ header,\ overall\ information\ about\ the\ media}}$**<br/>$\color{red}{\mathbf{åª’ä½“å¤´\ ,\ å…³äºåª’ä½“çš„æ€»ä½“ä¿¡æ¯}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{hdlr}}$** |                                  |                                      | âˆš    | $\color{red}{\mathbf{handler,\ declares\ the\ media\ (handler)\ type}}$<br />$\color{red}{\mathbf{åª’ä½“çš„æ’­æ”¾è¿‡ç¨‹ä¿¡æ¯}}$ |
|                                  |                                  |                                  | **$\color{red}{\mathbf{minf}}$** |                                  |                                      | âˆš    | $\color{red}{\mathbf{media\ information\ container}}$<br/>$\color{red}{\mathbf{åª’ä½“ä¿¡æ¯å®¹å™¨}}$ |
|                                  |                                  |                                  |                                  | vmhd                             |                                      |      | video media header, overall information<br/>(video track only) |
|                                  |                                  |                                  |                                  | smhd                             |                                      |      | sound media header, overall information<br/>(sound track only) |
|                                  |                                  |                                  |                                  | hmhd                             |                                      |      | hint media header, overall information<br/>(hint track only) |
|                                  |                                  |                                  |                                  | nmhd                             |                                      |      | Null media header, overall information<br/>(some tracks only) |
|                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{dinf}}$** |                                      | âˆš    | $\color{red}{\mathbf{data\ information\ box,\ container}}$<br/>$\color{red}{\mathbf{æ•°æ®ä¿¡æ¯box\ ,\ å®¹å™¨}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{dref}}$**     | âˆš    | $\color{red}{\mathbf{data\ reference\ box,\ declares\ source(s)\ of\ media\ data\ in\ track}}$<br/>$\color{red}{\mathbf{å¦‚ä½•å®šä½åª’ä½“ä¿¡æ¯}}$ |
|                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stbl}}$** |                                      | âˆš    | $\color{red}{\mathbf{sample\ table\ box,\ container\ for\ the\ time\ /\ space\ map}}$<br/>$\color{red}{\mathbf{åŒ…å«äº†trackä¸­çš„sampleçš„æ‰€æœ‰æ—¶é—´å’Œä½ç½®ä¿¡æ¯\ ,\ ä»¥åŠsampleçš„ç¼–è§£ç ç­‰ä¿¡æ¯ã€‚}}$<br />$\color{red}{\mathbf{åˆ©â½¤è¿™ä¸ªè¡¨å¯ä»¥è§£æsampleçš„æ—¶åºã€ç±»å‹ã€â¼¤â¼©ä»¥åŠåœ¨å„â¾ƒå­˜å‚¨å®¹å™¨ä¸­çš„ä½ç½®}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stsd}}$**     | âˆš    | $\color{red}{\mathbf{sample\ descriptions\ (codec\ types\ ,\ initialization\ etc.)}}$<br/>$\color{red}{\mathbf{å¦‚æœæ˜¯è§†é¢‘\ ,\ åŒ…å«:\ ç¼–ç ç±»å‹ã€å®½â¾¼ã€é•¿åº¦ç­‰ä¿¡æ¯;}}$<br/>$\color{red}{\mathbf{å¦‚æœæ˜¯â¾³é¢‘\ ,\ åŒ…å«:\ å£°é“ã€é‡‡æ ·ç‡ç­‰ä¿¡æ¯}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stts}}$**     | âˆš    | **$\color{red}{\mathbf{(decoding)\ time-to-sample}}$**<br/>**$\color{red}{\mathbf{æè¿°äº†sampleæ—¶åºçš„æ˜ å°„â½…æ³• , æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ‰¾åˆ°ä»»ä½•æ—¶é—´çš„sample}}$** |
|                                  |                                  |                                  |                                  |                                  | ctts                                 |      | (composition) time to sample                                 |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stsc}}$**     | âˆš    | $\color{red}{\mathbf{sample-to-chunk,\ partial\ data-offset\ information}}$<br/>$\color{red}{\mathbf{â½¤chunkç»„ç»‡sampleå¯ä»¥â½…ä¾¿ä¼˜åŒ–æ•°æ®è·å– , }}$<br/>$\color{red}{\mathbf{â¼€ä¸ªchunkåŒ…å«â¼€ä¸ªæˆ–å¤šä¸ªsample}}$ |
|                                  |                                  |                                  |                                  |                                  | **$\color{SkyBlue}{\mathbf{stsz}}$** |      | **$\color{SkyBlue}{\mathbf{sample\ sizes\ (framing)}}$**<br/>**$\color{SkyBlue}{\mathbf{æ¯ä¸ªsampleçš„â¼¤â¼©}}$**<br/>$\color{SkyBlue}{\mathbf{è™½ç„¶è¿™â¾¥æ²¡æœ‰æ‰“å‹¾ , ä½†å¯¹äºmp4è¿˜æ˜¯â¾®å¸¸å¿…è¦çš„}}$ |
|                                  |                                  |                                  |                                  |                                  | stz2                                 |      | compact sample sizes (framing)                               |
|                                  |                                  |                                  |                                  |                                  | **$\color{red}{\mathbf{stco}}$**     | âˆš    | $\color{red}{\mathbf{chunk\ offset\ partial\ data-offset\ information}}$<br/>$\color{red}{\mathbf{å®šä¹‰äº†æ¯ä¸ªchunkåœ¨åª’ä½“æµä¸­çš„åç§»ä½ç½®}}$ |
|                                  |                                  |                                  |                                  |                                  | co6                                  |      | 64-bit chunk offset                                          |
|                                  |                                  |                                  |                                  |                                  | 4                                    |      |                                                              |
|                                  |                                  |                                  |                                  |                                  | **$\color{SkyBlue}{\mathbf{stss}}$** |      | $\color{SkyBlue}{\mathbf{sync\ sample\ table\ (random\ access points)}}$<br/>$\color{SkyBlue}{\mathbf{â½¤äºç¡®å®šmediaä¸­çš„å…³é”®å¸§}}$ |
|                                  |                                  |                                  |                                  |                                  | stsh                                 |      | shadow sync sample table                                     |
|                                  |                                  |                                  |                                  |                                  | padb                                 |      | sample padding bits                                          |
|                                  |                                  |                                  |                                  |                                  | stdp                                 |      | sample degradation priority                                  |
|                                  |                                  |                                  |                                  |                                  | sdtp                                 |      | independent and disposable samples                           |
|                                  |                                  |                                  |                                  |                                  | sbgp                                 |      | sample-to-group                                              |
|                                  |                                  |                                  |                                  |                                  | sgpd                                 |      | sample group description                                     |
|                                  |                                  |                                  |                                  |                                  | subs                                 |      | sub-sample information                                       |
|                                  | mvex                             |                                  |                                  |                                  |                                      |      | movie extends box                                            |
|                                  |                                  | mehd                             |                                  |                                  |                                      |      | movie extends header box                                     |
|                                  |                                  | trex                             |                                  |                                  |                                      | âˆš    | track extends defaults                                       |
|                                  | ipmc                             |                                  |                                  |                                  |                                      |      | IPMP Control Box                                             |
| moof                             |                                  |                                  |                                  |                                  |                                      |      | movie fragment                                               |
|                                  | mfhd                             |                                  |                                  |                                  |                                      | âˆš    | movie fragment header                                        |
|                                  | traf                             |                                  |                                  |                                  |                                      |      | track fragment                                               |
|                                  |                                  | tfhd                             |                                  |                                  |                                      | âˆš    | track fragment header                                        |
|                                  |                                  | trun                             |                                  |                                  |                                      |      | track fragment run                                           |
|                                  |                                  | sdtp                             |                                  |                                  |                                      |      | independent and disposable samples                           |
|                                  |                                  | sbgp                             |                                  |                                  |                                      |      | sample-to-group                                              |
|                                  |                                  | subs                             |                                  |                                  |                                      |      | sub-sample information                                       |
| mfra                             |                                  |                                  |                                  |                                  |                                      |      | movie fragment random access                                 |
|                                  | tfra                             |                                  |                                  |                                  |                                      |      | track fragment random access                                 |
|                                  | mfro                             |                                  |                                  |                                  |                                      | âˆš    | movie fragment random access offset                          |
| mdat                             |                                  |                                  |                                  |                                  |                                      |      | media data container                                         |
| free                             |                                  |                                  |                                  |                                  |                                      |      | free space                                                   |
| skip                             |                                  |                                  |                                  |                                  |                                      |      | free space                                                   |
|                                  | udta                             |                                  |                                  |                                  |                                      |      | user-data                                                    |
|                                  |                                  | cprt                             |                                  |                                  |                                      |      | copyright etc                                                |
| meta                             |                                  |                                  |                                  |                                  |                                      |      | metadata                                                     |
|                                  | hdlr                             |                                  |                                  |                                  |                                      | âˆš    | handler, declares the metadata (handler) type                |
|                                  | dinf                             |                                  |                                  |                                  |                                      |      | data information box, container                              |
|                                  |                                  | dref                             |                                  |                                  |                                      |      | data reference box, declares source(s) of metadata items     |
|                                  | ipmc                             |                                  |                                  |                                  |                                      |      | IPMP Control Box                                             |
|                                  | iloc                             |                                  |                                  |                                  |                                      |      | item location                                                |
|                                  | ipro                             |                                  |                                  |                                  |                                      |      | item protection                                              |
|                                  |                                  | sinf                             |                                  |                                  |                                      |      | protection scheme information box                            |
|                                  |                                  |                                  | frma                             |                                  |                                      |      | original format box                                          |
|                                  |                                  |                                  | imif                             |                                  |                                      |      | IPMP Information box                                         |
|                                  |                                  |                                  | schm                             |                                  |                                      |      | scheme type box                                              |
|                                  |                                  |                                  | schi                             |                                  |                                      |      | scheme information box                                       |
|                                  | iinf                             |                                  |                                  |                                  |                                      |      | item information                                             |
|                                  | xml                              |                                  |                                  |                                  |                                      |      | XML container                                                |
|                                  | bxml                             |                                  |                                  |                                  |                                      |      | binary XML container                                         |
|                                  | pitm                             |                                  |                                  |                                  |                                      |      | primary item reference                                       |
|                                  | fiin                             |                                  |                                  |                                  |                                      |      | file delivery item information                               |
|                                  |                                  | paen                             |                                  |                                  |                                      |      | partition entry                                              |
|                                  |                                  |                                  | fpar                             |                                  |                                      |      | file partition                                               |
|                                  |                                  |                                  | fecr                             |                                  |                                      |      | FEC reservoir                                                |
|                                  |                                  | segr                             |                                  |                                  |                                      |      | file delivery session group                                  |
|                                  |                                  | gitn                             |                                  |                                  |                                      |      | group id to name                                             |
|                                  |                                  | tsel                             |                                  |                                  |                                      |      | track selection                                              |
| meco                             |                                  |                                  |                                  |                                  |                                      |      | additional metadata container                                |
|                                  | mere                             |                                  |                                  |                                  |                                      |      | metabox relation                                             |

æœ¬â½‚ä½¿â½¤mediainfoå’Œmp4boxè¿›â¾åˆ†æ

å›¾ä¸­çœ‹åˆ°mp4â½‚ä»¶ç”±â¼ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ† , ä¸‹â¾¯ä»¥ğŸ“ 2_audio_track_5s.mp4â½‚ä»¶ä¸ºåˆ†ææ¡ˆä¾‹

## 2.1 ftyp

File Type Box , â¼€èˆ¬åœ¨â½‚ä»¶çš„å¼€å§‹ä½ç½® , æè¿°çš„â½‚ä»¶çš„ç‰ˆæœ¬ã€å…¼å®¹åè®®ç­‰

> ```tex
> 000000 File Type (32 bytes)
> 000000  Header (8 bytes)
> 000000   Size:                                 32 (0x00000020)
> 000004   Name:                                 ftyp
> 000008  MajorBrand:                            isom
> 00000C  MajorBrandVersion:                     512 (0x00000200)
> 000010  CompatibleBrand:                       isom
> 000014  CompatibleBrand:                       iso2
> 000018  CompatibleBrand:                       avc1
> 00001C  CompatibleBrand:                       mp41
>                             ftypå†…å®¹
> ```

## 2.2 moov

Movie Box , åŒ…å«æœ¬â½‚ä»¶ä¸­æ‰€æœ‰åª’ä½“æ•°æ®çš„å®è§‚æè¿°ä¿¡æ¯ä»¥åŠæ¯è·¯åª’ä½“è½¨é“çš„å…·ä½“ä¿¡æ¯ã€‚â¼€èˆ¬ä½äºæ”¾åœ¨â½‚ä»¶æœ«å°¾ , ä½†å¦‚æœä¸ºäº†â½€æŒhttpè¾¹ä¸‹è½½è¾¹æ’­æ”¾åˆ™éœ€è¦å°†moovæå‰ã€‚æ³¨æ„ , $\color{red}{\mathbf{å½“æ”¹å˜moovä½ç½®æ—¶,å†…éƒ¨â¼€äº›å€¼éœ€è¦é‡æ–°è®¡ç®—}}$

> ```tex
> 14B2CE File header (10341 bytes)
> 14B2CE  Header (8 bytes)
> 14B2CE   Size:                                 10341 (0x00002865)
> 14B2D2   Name:                                 moov
> ```

